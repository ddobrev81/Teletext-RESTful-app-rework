<?php

/*
 * Implements hook_menu()
 */

function ttv_teletext_menu() {
  $items['teletext-list'] = array(
    'title' => 'Teletext',
    'page callback' => 'ttv_display_links',
    'access callback' => TRUE,
  );
  $items['ttv_teletext_pages/%/%'] = array(
    'title' => 'teletext_pages',
    'page callback' => 'ttv_teletext_pages',
    'page arguments' => array(1, 2),
    'access callback' => TRUE,
  );
  $items['admin/config/system/notifications'] = array(
    'title' => 'Notification settings',
    'description' => 'View and change notification emails',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ttv_teletext_settings'),
    'access arguments' => array('administer users'),
    'type' => MENU_NORMAL_ITEM,
   );
  return $items;
}

/*
 * Custom call back function that calls out page building functions
 */

function ttv_teletext_pages($pages, $channel) {
  if (function_exists('ttv_teletext_pages_' . $pages)) {
    call_user_func('ttv_teletext_pages_' . $pages, $channel);
  }
}

/*
 * Build a table with our teletext update links
 */

function ttv_display_links() {

  $columns = array('Channel', 'Pages', 'Update', 'Help');
  foreach ($columns as $col) {
    $headers[] = array('data' => $col);
  }

  $channels = array('Kanal 4', 'Kanal 5', '6\'eren');
  $pages = array('100-101', '301-304', '305-329', '335-341', '361-364', '365-368');
  foreach ($pages as $page) {
    $pages_underscored[] = str_replace('-', '_', $page);
  }
  $pages_help = array('Current and next program', 'Daily program Channel4', 'Review program of Channel 4', 'Weekly program channel 4', 'Daily program Channel5', 'Daily program Channel6');
  foreach ($channels as $k => $v) {
    foreach ($pages as $k1 => $v1) {
      $index = $k + 1;
      $rows[] = array(
        'data' => array(
          array('data' => t($v)),
          array('data' => t($v1)),
          array('data' => l(t('Update'), "ttv_teletext_pages/$pages_underscored[$k1]/$index", array('attributes' => array('target' => '_blank')))),
          array('data' => t($v . ' - ' . $pages_help[$k1])),
        )
      );
    }
  }

  return theme('table', array(
    'header' => $headers,
    'rows' => $rows,)
  );
}

function ttv_teletext_theme($existing, $type, $theme, $path) {
  return array(
    'pages_100_101' => array(
      'variables' => array('variables' => NULL),
      'path' => drupal_get_path('module', 'ttv_teletext'),
      'template' => 'pages_100_101'
    ),
    'pages_301_304' => array(
      'variables' => array('variables' => NULL),
      'path' => drupal_get_path('module', 'ttv_teletext'),
      'template' => 'pages_301_304'
    ),
    'pages_305_329' => array(
      'variables' => array('variables' => NULL),
      'path' => drupal_get_path('module', 'ttv_teletext'),
      'template' => 'pages_305_329'
    ),
    'pages_335_341' => array(
      'variables' => array('variables' => NULL),
      'path' => drupal_get_path('module', 'ttv_teletext'),
      'template' => 'pages_335_341'
    ),
    'pages_361_364' => array(
      'variables' => array('variables' => NULL),
      'path' => drupal_get_path('module', 'ttv_teletext'),
      'template' => 'pages_361_364'
    ),
    'pages_365_368' => array(
      'variables' => array('variables' => NULL),
      'path' => drupal_get_path('module', 'ttv_teletext'),
      'template' => 'pages_365_368'
    ),
  );
}

/*
 * Custom function to build xml output for specified channel for pages 301-304
 */

function ttv_teletext_pages_301_304($channel_tid) {
  switch ($channel_tid) {
    case 1:
      $station = "Kanal 4";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 301, 0, 1);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_301_304', $variables);

      /*
        $page305 = $pages[1];
        $page306 = $pages[2];
        $page307 = $pages[3];
        $page308 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?> \n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $page305 . $page306 . $page307 . $page308;
        $xml .= "</teletext>"; */
      break;
    case 2:
      $station = "Kanal 5";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 301, 0, 1);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_301_304', $variables);

      /*
        $page305 = $pages[1];
        $page306 = $pages[2];
        $page307 = $pages[3];
        $page308 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?> \n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $page305 . $page306 . $page307 . $page308;
        $xml .= "</teletext>"; */
      break;
    case 3:
      $station = "6eren";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 301, 0, 1);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_301_304', $variables);

      /*
        $page305 = $pages[1];
        $page306 = $pages[2];
        $page307 = $pages[3];
        $page308 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?> \n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $page305 . $page306 . $page307 . $page308;
        $xml .= "</teletext>"; */
      break;
  }
  //$xml = mb_convert_encoding($xml, "iso-8859-1");
  //_ttv_teletext_send_curl($xml);
  print $xml;
}

/*
 * Custom function to build xml output for specified channel for pages 305-329
 */

function ttv_teletext_pages_305_329($channel_tid) {
  switch ($channel_tid) {
    case 1:
      $station = "Kanal 4";
      $main_channel = 'KANAL4';
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_xml_305_329($channel_tid, $station, $main_channel, $date, $datetext);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_305_329', $variables);
      break;
    case 2:
      $station = "Kanal 5";
      $main_channel = 'KANAL5';
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_xml_305_329($channel_tid, $station, $main_channel, $date, $datetext);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_305_329', $variables);
      break;
    case 3:
      $station = '6eren';
      $main_channel = 'SBSNET';
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_xml_305_329($channel_tid, $station, $main_channel, $date, $datetext);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_305_329', $variables);
      break;
  }
  //$xml = mb_convert_encoding($xml, "iso-8859-1");
  print $xml;
  //_ttv_teletext_send_curl($xml);
}

/*
 * Custom function to build xml output for specified channel for pages 335-341
 */

function ttv_teletext_pages_335_341($channel_tid) {
  switch ($channel_tid) {
    case 1:
      //monday
      $station = "Kanal 4";
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 1) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }
      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 335, 1, 0);


      $output[1] = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 335, 1, 0);

      /* $tekstpage3341 = $pages[1];
        $tekstpage3342 = $pages[2];
        $tekstpage3343 = $pages[3];
        $tekstpage3344 = $pages[4]; */

      //thuesday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 2) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 336, 1, 0);

      $output[2] = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 336, 1, 0);

      /* $tekstpage3351 = $pages[1];
        $tekstpage3352 = $pages[2];
        $tekstpage3353 = $pages[3];
        $tekstpage3354 = $pages[4]; */

      //wednesday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 3) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 337, 1, 0);
      $output[3] = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 337, 1, 0);
      /* $tekstpage3361 = $pages[1];
        $tekstpage3362 = $pages[2];
        $tekstpage3363 = $pages[3];
        $tekstpage3364 = $pages[4]; */

      //thursday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 4) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);


      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 338, 1, 0);

      $output[4] = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 338, 1, 0);
      /* $tekstpage3371 = $pages[1];
        $tekstpage3372 = $pages[2];
        $tekstpage3373 = $pages[3];
        $tekstpage3374 = $pages[4]; */

      //friday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 5) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 339, 1, 0);
      $output[5] = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 339, 1, 0);

      /* $tekstpage3381 = $pages[1];
        $tekstpage3382 = $pages[2];
        $tekstpage3383 = $pages[3];
        $tekstpage3384 = $pages[4]; */

      //saturday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 6) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 340, 1, 0);
      $output[6] = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 340, 1, 0);

      /* $tekstpage3391 = $pages[1];
        $tekstpage3392 = $pages[2];
        $tekstpage3393 = $pages[3];
        $tekstpage3394 = $pages[4]; */

      //sunday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 0) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 341, 1, 0);
      $output[7] = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 341, 1, 0);

      /* $tekstpage3401 = $pages[1];
        $tekstpage3402 = $pages[2];
        $tekstpage3403 = $pages[3];
        $tekstpage3404 = $pages[4]; */

      /* $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n"; */
      /* $xml .= $tekstpage3341 . $tekstpage3342 . $tekstpage3343 . $tekstpage3344 . $tekstpage3351 . $tekstpage3352 . $tekstpage3353 . $tekstpage3354;
        $xml .= $tekstpage3361 . $tekstpage3362 . $tekstpage3363 . $tekstpage3364 . $tekstpage3371 . $tekstpage3372 . $tekstpage3373 . $tekstpage3374;
        $xml .= $tekstpage3381 . $tekstpage3382 . $tekstpage3383 . $tekstpage3384 . $tekstpage3391 . $tekstpage3392 . $tekstpage3393 . $tekstpage3394;
        $xml .= $tekstpage3401 . $tekstpage3402 . $tekstpage3403 . $tekstpage3404; */
      //$xml .= "</teletext>";

      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= '<teletext user="propeople" pass="tvdanmark">';
      $xml.= "\n";
      foreach ($output as $out) {
        $variables['output'] = $out;
        $xml .= theme('pages_335_341', $variables);
      }
      $xml .= '</teletext>';


      //$xml .= theme('pages_335_341', $variables);

      break;
    case 2:
      //monday
      $station = "Kanal 5";
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 1) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }
      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 335, 1, 0);


      $output[1] = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 335, 1, 0);


      /* $tekstpage3341 = $pages[1];
        $tekstpage3342 = $pages[2];
        $tekstpage3343 = $pages[3];
        $tekstpage3344 = $pages[4]; */

      //thuesday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 2) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 336, 1, 0);

      $output[2] = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 336, 1, 0);

      /* $tekstpage3351 = $pages[1];
        $tekstpage3352 = $pages[2];
        $tekstpage3353 = $pages[3];
        $tekstpage3354 = $pages[4]; */

      //wednesday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 3) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 337, 1, 0);
      $output[3] = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 337, 1, 0);
      /* $tekstpage3361 = $pages[1];
        $tekstpage3362 = $pages[2];
        $tekstpage3363 = $pages[3];
        $tekstpage3364 = $pages[4]; */

      //thursday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 4) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 338, 1, 0);

      $output[4] = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 338, 1, 0);
      /* $tekstpage3371 = $pages[1];
        $tekstpage3372 = $pages[2];
        $tekstpage3373 = $pages[3];
        $tekstpage3374 = $pages[4]; */

      //friday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 5) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 339, 1, 0);
      $output[5] = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 339, 1, 0);

      /* $tekstpage3381 = $pages[1];
        $tekstpage3382 = $pages[2];
        $tekstpage3383 = $pages[3];
        $tekstpage3384 = $pages[4]; */

      //saturday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 6) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 340, 1, 0);
      $output[6] = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 340, 1, 0);

      /* $tekstpage3391 = $pages[1];
        $tekstpage3392 = $pages[2];
        $tekstpage3393 = $pages[3];
        $tekstpage3394 = $pages[4]; */

      //sunday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 0) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 341, 1, 0);
      $output[7] = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 341, 1, 0);

      /* $tekstpage3401 = $pages[1];
        $tekstpage3402 = $pages[2];
        $tekstpage3403 = $pages[3];
        $tekstpage3404 = $pages[4]; */

      /* $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n"; */
      /* $xml .= $tekstpage3341 . $tekstpage3342 . $tekstpage3343 . $tekstpage3344 . $tekstpage3351 . $tekstpage3352 . $tekstpage3353 . $tekstpage3354;
        $xml .= $tekstpage3361 . $tekstpage3362 . $tekstpage3363 . $tekstpage3364 . $tekstpage3371 . $tekstpage3372 . $tekstpage3373 . $tekstpage3374;
        $xml .= $tekstpage3381 . $tekstpage3382 . $tekstpage3383 . $tekstpage3384 . $tekstpage3391 . $tekstpage3392 . $tekstpage3393 . $tekstpage3394;
        $xml .= $tekstpage3401 . $tekstpage3402 . $tekstpage3403 . $tekstpage3404; */
      //$xml .= "</teletext>";

      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= '<teletext user="propeople" pass="tvdanmark">';
      $xml.= "\n";
      foreach ($output as $out) {
        $variables['output'] = $out;
        $xml .= theme('pages_335_341', $variables);
      }
      $xml .= '</teletext>';


      //$xml .= theme('pages_335_341', $variables);
      break;
    case 3:
      $station = "6eren";

      //monday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 1) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }
      $datetext = _ttv_teletext_datetext($date);
//$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 335, 1, 0);


      $output[1] = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 335, 1, 0);

      /* $tekstpage3341 = $pages[1];
        $tekstpage3342 = $pages[2];
        $tekstpage3343 = $pages[3];
        $tekstpage3344 = $pages[4]; */

      //thuesday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 2) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 336, 1, 0);

      $output[2] = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 336, 1, 0);

      /* $tekstpage3351 = $pages[1];
        $tekstpage3352 = $pages[2];
        $tekstpage3353 = $pages[3];
        $tekstpage3354 = $pages[4]; */

      //wednesday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 3) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 337, 1, 0);
      $output[3] = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 337, 1, 0);
      /* $tekstpage3361 = $pages[1];
        $tekstpage3362 = $pages[2];
        $tekstpage3363 = $pages[3];
        $tekstpage3364 = $pages[4]; */

      //thursday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 4) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 338, 1, 0);

      $output[4] = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 338, 1, 0);
      /* $tekstpage3371 = $pages[1];
        $tekstpage3372 = $pages[2];
        $tekstpage3373 = $pages[3];
        $tekstpage3374 = $pages[4]; */

      //friday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 5) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 339, 1, 0);
      $output[5] = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 339, 1, 0);

      /* $tekstpage3381 = $pages[1];
        $tekstpage3382 = $pages[2];
        $tekstpage3383 = $pages[3];
        $tekstpage3384 = $pages[4]; */

      //saturday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 6) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 340, 1, 0);
      $output[6] = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 340, 1, 0);

      /* $tekstpage3391 = $pages[1];
        $tekstpage3392 = $pages[2];
        $tekstpage3393 = $pages[3];
        $tekstpage3394 = $pages[4]; */


      //sunday
      for ($i = 1; $i <= 7; $i++) {
        $weekday = date("w", floor(time() + ($i * 86400)));
        if ($weekday == 0) {
          $date = date("Y-m-d", floor(time() + ($i * 86400)));
        }
      }

      $datetext = _ttv_teletext_datetext($date);

      //$pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 341, 1, 0);
      $output[7] = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 341, 1, 0);

      /* $tekstpage3401 = $pages[1];
        $tekstpage3402 = $pages[2];
        $tekstpage3403 = $pages[3];
        $tekstpage3404 = $pages[4]; */

      /* $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n"; */
      /* $xml .= $tekstpage3341 . $tekstpage3342 . $tekstpage3343 . $tekstpage3344 . $tekstpage3351 . $tekstpage3352 . $tekstpage3353 . $tekstpage3354;
        $xml .= $tekstpage3361 . $tekstpage3362 . $tekstpage3363 . $tekstpage3364 . $tekstpage3371 . $tekstpage3372 . $tekstpage3373 . $tekstpage3374;
        $xml .= $tekstpage3381 . $tekstpage3382 . $tekstpage3383 . $tekstpage3384 . $tekstpage3391 . $tekstpage3392 . $tekstpage3393 . $tekstpage3394;
        $xml .= $tekstpage3401 . $tekstpage3402 . $tekstpage3403 . $tekstpage3404; */
      //$xml .= "</teletext>";

      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= '<teletext user="propeople" pass="tvdanmark">';
      $xml.= "\n";
      foreach ($output as $out) {
        $variables['output'] = $out;
        $xml .= theme('pages_335_341', $variables);
      }
      $xml .= '</teletext>';


      //$xml .= theme('pages_335_341', $variables);

      break;
  }
  //$xml = mb_convert_encoding($xml, "iso-8859-1");
  print $xml;
  //_ttv_teletext_send_curl($xml);
}

/*
 * Custom function to build xml output for specified channel for pages 361-364
 */

function ttv_teletext_pages_361_364($channel_tid) {
  switch ($channel_tid) {
    case 1:
      $station = "Kanal 5";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);

      $output = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 361, 0, 0);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_361_364', $variables);

      /* $pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 361, 0, 0);

        $tekstpage301 = $pages[1];
        $tekstpage302 = $pages[2];
        $tekstpage303 = $pages[3];
        $tekstpage304 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $tekstpage301 . $tekstpage302 . $tekstpage303 . $tekstpage304;
        $xml .= "</teletext>";
       */
      break;
    case 2:
      $station = "Kanal 4";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);

      $output = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 361, 0, 0);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_361_364', $variables);

      /* $pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 361, 0, 0);

        $tekstpage301 = $pages[1];
        $tekstpage302 = $pages[2];
        $tekstpage303 = $pages[3];
        $tekstpage304 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $tekstpage301 . $tekstpage302 . $tekstpage303 . $tekstpage304;
        $xml .= "</teletext>";
       */
      break;
    case 3:
      $station = "Kanal 4";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 361, 0, 0);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_361_364', $variables);

      /* $pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 361, 0, 0);

        $tekstpage301 = $pages[1];
        $tekstpage302 = $pages[2];
        $tekstpage303 = $pages[3];
        $tekstpage304 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $tekstpage301 . $tekstpage302 . $tekstpage303 . $tekstpage304;
        $xml .= "</teletext>";
       */

      break;
  }
  //$xml = mb_convert_encoding($xml, "iso-8859-1");

  print $xml;
  //_ttv_teletext_send_curl($xml);
}

/*
 * Custom function to build xml output for specified channel for pages 365-368
 */

function ttv_teletext_pages_365_368($channel_tid) {
  switch ($channel_tid) {
    case 1:
      $station = "6eren";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, 365, 0, 0);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_365_368', $variables);

      /* $pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 361, 0, 0);

        $tekstpage301 = $pages[1];
        $tekstpage302 = $pages[2];
        $tekstpage303 = $pages[3];
        $tekstpage304 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $tekstpage301 . $tekstpage302 . $tekstpage303 . $tekstpage304;
        $xml .= "</teletext>";
       */
      break;
    case 2:
      $station = "6eren";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, 365, 0, 0);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_365_368', $variables);

      /* $pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 361, 0, 0);

        $tekstpage301 = $pages[1];
        $tekstpage302 = $pages[2];
        $tekstpage303 = $pages[3];
        $tekstpage304 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $tekstpage301 . $tekstpage302 . $tekstpage303 . $tekstpage304;
        $xml .= "</teletext>";
       */
      break;
    case 3:
      $station = "Kanal 5";
      $date = date("Y-m-d");
      $datetext = _ttv_teletext_datetext($date);
      $output = _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, 365, 0, 0);
      $variables['output'] = $output;
      $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
      $xml .= theme('pages_365_368', $variables);

      /* $pages = _ttv_teletext_build_kanal4_pages($station, $date, $datetext, 361, 0, 0);

        $tekstpage301 = $pages[1];
        $tekstpage302 = $pages[2];
        $tekstpage303 = $pages[3];
        $tekstpage304 = $pages[4];

        $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n";
        $xml .= $tekstpage301 . $tekstpage302 . $tekstpage303 . $tekstpage304;
        $xml .= "</teletext>";
       */
      break;
  }
  //$xml = mb_convert_encoding($xml, "iso-8859-1");
  print $xml;
  //_ttv_teletext_send_curl($xml);
}

/*
 * Custom function to build xml output for specified channel for pages 100-101
 */

function ttv_teletext_pages_100_101($channel_tid) {
  $output = array();

  //determine channel order
  $channel = _ttv_teletext_determine_channel_order($channel_tid);


  //determine if NOW is between 00:00 and 05:55
  if (date("Hi", time()) < 555 && date("Hi", time()) >= 0) {
    $date = date("Y-m-d", floor(time() - 86400));
    $dateplusone = date("Y-m-d", time());
  }
  else {
    $date = date("Y-m-d", time());
    $dateplusone = date("Y-m-d", floor(time() + 86400));
  }
  $datenow = date("Y-m-d", time());
  $datetext = _ttv_teletext_datetext($date);


  $data = _ttv_teletext_get_data($date, $channel[0], '05:56:00');

  //find onair program
  $current_time = date('H:i:s');
  foreach ($data as $k => $v) {
    if (($v['start_time'] < $current_time) && ($v['end_time'] > $current_time) && ($v['start_time'] != $v['end_time'])) {
      $data[$k]['onair'] = TRUE;
    }
    else {
      $data[$k]['onair'] = FALSE;
    }
  }

  //find current program on air
  foreach ($data as $k => $v) {
    if ($v['onair']) {
      $onair_index = $k;
    }
  }
  //create current program text
  if ($data[$onair_index]['hd'] == 'yes') {
    $hdtext = "(HD) ";
  }
  else {
    $hdtext = "";
  }
  if ($data[$onair_index]['local'] == 'yes') {
    $localtext = "/lok. prg. ";
  }
  else {
    $localtext = "";
  }
  $extratitle = "";
  if ($data[$onair_index]['repeat'] != 0 && $data[$onair_index]['repeat'] != "" && $data[$onair_index]['repeat'] != "1" && trim($data[$onair_index]['repeat']) != "(G)") {
    $current_program_onair_text = _ttv_teletext_check_danish($data[$onair_index]['title'] . " " . $extratitle . $hdtekst . $data[$onair_index]['repeat'] . $localtekst . " NEWLINE " . $data[$onair_index]['genre']);
  }
  else {
    if ($data[$onair_index]['repeat'] == "1" || trim($data[$onair_index]['repeat']) == "(G)") {
      $current_program_onair_text = _ttv_teletext_check_danish($data[$onair_index]['title'] . " " . $extratitle . $hdtext . "(G) " . $localtext . "NEWLINE " . $data[$onair_index]['genre']);
    }
    else {
      $current_program_onair_text = _ttv_teletext_check_danish($data[$onair_index]['title'] . " " . $extratitle . $hdtext . $localtext . "NEWLINE " . $data[$onair_index]['genre']);
    }
  }
  $onair_index_next = $onair_index + 1;
  if ($onair_index_next > count($data)) {
    //HANDLE EXTREME FRINGE CASE WHERE NEXT PROGRAM IS THE FIRST PROGRAM FROM THE NEXT DAY
  }
  else {
    //create next program text
    if ($data[$onair_index_next]['hd'] == 'yes') {
      $hdtext = "(HD) ";
    }
    else {
      $hdtext = "";
    }
    if ($data[$onair_index_next]['local'] == 'yes') {
      $localtext = "/lok. prg. ";
    }
    else {
      $localtext = "";
    }
    $extratitle = "";
    if ($data[$onair_index_next]['repeat'] != 0 && $data[$onair_index_next]['repeat'] != "" && $data[$onair_index_next]['repeat'] != "1" && trim($data[$onair_index_next]['repeat']) != "(G)") {
      $next_program_onair_text = _ttv_teletext_check_danish($data[$onair_index_next]['title'] . " " . $extratitle . $hdtekst . $data[$onair_index_next]['repeat'] . $localtekst . " NEWLINE " . $data[$onair_index_next]['genre']);
    }
    else {
      if ($data[$onair_index_next]['repeat'] == "1" || trim($data[$onair_index_next]['repeat']) == "(G)") {
        $next_program_onair_text = _ttv_teletext_check_danish($data[$onair_index_next]['title'] . " " . $extratitle . $hdtext . "(G) " . $localtext . "NEWLINE " . $data[$onair_index_next]['genre']);
      }
      else {
        $next_program_onair_text = _ttv_teletext_check_danish($data[$onair_index_next]['title'] . " " . $extratitle . $hdtext . $localtext . "NEWLINE " . $data[$onair_index_next]['genre']);
      }
    }
  }
  $current_program_onair_text_split['line'] = _ttv_teletext_split_2lines($current_program_onair_text);
  $next_program_onair_text_split['line'] = _ttv_teletext_split_2lines($next_program_onair_text);

  $current_program_onair_text_split['line'][0] = str_replace("NEWLINEDONE", "", $current_program_onair_text_split['line'][0]);

  $current_program_onair_text_split['properties']['lenght'] = 29 - strlen($current_program_onair_text_split['line'][0]);
  $current_program_onair_text_split['properties']['spaces'] = "";
  for ($i = 1; $i <= $current_program_onair_text_split['properties']['lenght']; $i++) {
    $current_program_onair_text_split['properties']['spaces'] .= " ";
  }

  $next_program_onair_text_split['line'][0] = str_replace("NEWLINEDONE", "", $next_program_onair_text_split['line'][0]);

  $next_program_onair_text_split['properties']['lenght'] = 29 - strlen($next_program_onair_text_split['line'][0]);
  $next_program_onair_text_split['properties']['spaces'] = "";
  for ($i = 1; $i <= $next_program_onair_text_split['properties']['lenght']; $i++) {
    $next_program_onair_text_split['properties']['spaces'] .= " ";
  }

  $start_time = substr($data[$onair_index]['actual_start_time'], 0, 5);
  $start_time = str_replace(":", "", $start_time);
  if (strlen($data[$onair_index]['end_time']) >= 1) {
    $end_time = substr($data[$onair_index]['end_time'], 0, 5);
    $end_time = str_replace(":", "", $end_time);
  }
  else {
    $end_time = substr($data[$onair_index_next]['actual_start_time'], 0, 5);
    $end_time = str_replace(":", "", $end_time);
  }
  if (intval($start_time) >= 0 && intval($start_time) <= 500) {
    $start_date = date("Y-m-d", floor(strtotime($date) + 86400));
  }
  else {
    $start_date = $date;
  }
  if (intval($end_time) >= 0 && intval($end_time) <= 500) {
    $end_date = date("Y-m-d", floor(strtotime($date) + 86400));
  }
  else {
    $end_date = $date;
  }

  $seconds_count = strtotime($end_date . " " . substr($end_date, 0, 2) . ":" . substr($end_date, 2, 2) . ":00") - strtotime(date("Y-m-d H:i:s"));
  $seconds_count_total = strtotime($end_date . " " . substr($end_date, 0, 2) . ":" . substr($end_date, 2, 2) . ":00") - strtotime($start_date . " " . substr($start_time, 0, 2) . ":" . substr($start_time, 2, 2) . ":00");
  $seconds_count_percent = (($seconds_count / $seconds_count_total) * 100);
  if ($seconds_count_percent > 100) {
    $yellow_counter = 16;
    $red_counter = 0;
  }
  else {
    $yellow_counter = floor($seconds_count_percent / 6.66);
    $red_counter = 15 - $yellow_counter;
  }

  $program_red = "";
  //print $red_counter . "<br>";
  for ($i = 1; $i <= $red_counter; $i++) {
    if ($program_red == "") {
      $program_red = "<redgraphics/>,";
    }
    else {
      $program_red .= ",";
    }
  }
  $program_yellow = "";
  //print $yellow_counter . "<br>";
  for ($i = 1; $i <= $yellow_counter; $i++) {
    if ($program_yellow == "") {
      $program_yellow = "<yellowgraphics/>,";
    }
    else {
      $program_yellow .= ",";
    }
  }
  if ($program_red == 0) {
    $yellow_counter .= ",";
  }
  if ($yellow_counter == 0) {
    $program_red .= ",";
  }

  $sub_page = 1;
  if (!empty($data[$onair_index]['ttv'])) {
    $onair_ttv_flag = $data[$onair_index]['program_id'];
    $onair_ttv_text = $data[$onair_index]['ttv'];
  }
  else {
    $onair_ttv_flag = 0;
    $onair_ttv_text = '';
  }
  if (!empty($data[$onair_index_next]['ttv'])) {
    $onair_ttv_flag_next = $data[$onair_index_next]['program_id'];
    $onair_next_ttv_text = $data[$onair_index_next]['ttv'];
  }
  else {
    $onair_ttv_flag_next = 0;
    $onair_next_ttv_text = '';
  }
  if (!$onair_ttv_flag == 0) {

    $output['pages'][1]['channel'] = $channel['main'];
    $output['pages'][1]['num'] = '101';
    $output['pages'][1]['sub'] = '1';
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    $output['pages'][1]['lines'][3]['text'] = 'Der er ingen omtale til det aktuelle';
    $output['pages'][1]['lines'][3]['color'] = 'white';
    $output['pages'][1]['lines'][4]['text'] = 'program.';
    $output['pages'][1]['lines'][4]['color'] = 'white';

    /* $output .= "<page inserter=\"" . $channel['main'] . "\" num=\"101\" sub=\"1\" language=\"S\">\n";
      $output .= "<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
      $output .= "<line num=\"3\"><white/>Der er ingen omtale til det aktuelle</line>\n";
      $output .= "<line num=\"4\"><white/>program.</line>\n";
      $output .= "</page>\n"; */
    $sub = 2;
  }
  if ($onair_ttv_flag_next == 0) {
    $output['pages'][2]['channel'] = $channel['main'];
    $output['pages'][2]['num'] = '101';
    $output['pages'][2]['sub'] = '2';
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    $output['pages'][2]['lines'][3]['text'] = 'Der er ingen omtale til det næste';
    $output['pages'][2]['lines'][3]['color'] = 'white';
    $output['pages'][2]['lines'][4]['text'] = 'program.';
    $output['pages'][2]['lines'][4]['color'] = 'white';

    /* $output .= "<page inserter=\"" . $channel['main'] . "\" num=\"101\" sub=\"2\" language=\"S\">\n";
      $output .= "<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
      $output .= "<line num=\"3\"><white/>Der er ingen omtale til det næste</line>\n";
      $output .= "<line num=\"4\"><white/>program.</line>\n";
      $output .= "</page>\n"; */
  }

  //this needs to pass everytime!!!!
  if (strlen($data[$onair_index]['description']) >= 1) {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 20; $i++) {
      $topspaces .= " ";
    }
    $output['pages'][3]['channel'] = $channel['main'];
    $output['pages'][3]['num'] = '101';
    $output['pages'][3]['sub'] = $sub_page;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext . $topspaces . $data[$onair_index]['start_time'] . '-' . $data[$onair_index]['end_time'];
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    /* $output .= "<page inserter=\"" . $channel['main'] . "\" num=\"101\" sub=\"" . $sub_page . "\" language=\"S\">\n";
      $output .= "<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . $data[$onair_index]['start_time'] . "-" . $data[$onair_index]['end_time'] . "</line>\n";
     */
    $linenumber = 3;

    if (strlen($data[$onair_index]['press_number']) >= 1) {
      $extratitle .= "(" . $data[$onair_index]['press_number'] . ") ";
    }
    if ($data[$onair_index]['repeat'] == "1" || trim($data[$onair_index]['repeat']) == "(G)") {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['title'] . $extratitle . " (G)"), $linenumber, $output, 0);
    }
    else {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['title'] . $extratitle), $linenumber, $output, 0);
    }
    //$output .= $result[1];
    $output['pages'][3]['lines'] = $result[1];
    $linenumber = $result[2];
    $linenumber += 1;

    $extra_row = 0;
    if (strlen($data[$onair_index]['genre']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['genre']), $linenumber, $output, 1);
      $output['pages'][3]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
      $extra_row = 1;
    }
    if ($data[$onair_index]['hd'] == "yes") {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish("(Kan ses i HD)"), $linenumber, $output, 1);
      $output['pages'][3]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
      $extra_row = 1;
    }
    if (strlen($data[$onair_index]['original_title']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['original_title']), $linenumber, $output, 1);
      $output['pages'][3]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
      $extra_row = 1;
    }
    if ($extra_row == 1) {
      $linenumber++;
    }

    $extra_line = 0;
    if (strlen($data[$onair_index]['actors']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['actors']), $extra_line, $output, 1);
      $extra_line = $result[2];
    }
    if (strlen($data[$onair_index]['instructions']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['instructions']), $extra_line, $output, 1);
      $extra_line = $result[2];
    }

    $line_text = "";
    $description = explode(".", _ttv_teletext_check_danish($data[$onair_index]['description']));
    $description_line_num = 0;
    $count = 0;
    foreach ($description as $text_num => $text) {
      $description2 = explode(" ", $text);
      foreach ($description2 as $text_num2 => $text2) {
        if (strlen($text2) >= 40) {
          # CUT EFTER 40 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
          if (strlen($line_text) >= 1) {
            $line_text .= " ";
          }
          $textlen = (37 - strlen($line_text));
          $line_text .= substr($text2, 0, (37 - strlen($line_text))) . "-";
          $description_line_num += 1;
          $line_text = substr($text2, (37 - strlen($line_text)), strlen($text2));
        }
        else {
          # HVIS $text2 + $line_text >= 40 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
          if ((strlen($text2) + strlen($line_text)) >= 39) {
            $description_line_num += 1;
            $line_text = $text2;
          }
          else {
            if (strlen($line_text) >= 1) {
              $line_text .= " ";
            }
            $line_text .= $text2;
          }
        }
      }
      if ($description_line_num <= (20 - $description_line_num - $extra_line)) {
        $count += 1;
      }
    }

    $line_text = "";
    for ($i = 1; $i <= $count; $i++) {
      $description2 = explode(" ", $description[($i - 1)] . ".");
      foreach ($description2 as $text_num2 => $text) {
        if (strlen($text) >= 1) {
          if ((!(strlen($text) == 1 && stristr($text, ".")))) {
            if (strlen($text) >= 40) {
              # CUT EFTER 40 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
              if (strlen($line_text) >= 1) {
                if (substr($line_text, -1) == "." && (!(is_numeric(substr(substr($line_text, -2), 0, 1))))) {
                  $line_text .= " ";
                }
                elseif (substr($line_text, -1) != ".") {
                  $line_text .= " ";
                }
              }
              $textlen = (37 - strlen($line_text));
              $line_text .= substr($text, 0, (37 - strlen($line_text))) . "-";
              $output['pages'][3]['lines'][$linenumber]['text'] = ($line_text);
              //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
              $linenumber += 1;
              $line_text = substr($text, (37 - strlen($line_text)), strlen($text));
            }
            else {
              # HVIS $text + $line_text >= 40 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
              if ((strlen($text) + strlen($line_text)) >= 39) {
                $output['pages'][3]['lines'][$linenumber]['text'] = ($line_text);
                //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
                $linenumber += 1;
                $line_text = $text;
              }
              else {
                if (strlen($line_text) >= 1) {
                  if (substr($line_text, -1) == "." && (!(is_numeric(substr(substr($line_text, -2), 0, 1))))) {
                    $line_text .= " ";
                  }
                  elseif (substr($line_text, -1) != ".") {
                    $line_text .= " ";
                  }
                }
                $line_text .= $text;
              }
            }
          }
        }
      }
    }
    $output['pages'][3]['lines'][$linenumber]['text'] = ($line_text);
    //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
    $linenumber += 1;

    if (strlen($data[$onair_index]['actors']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['actors']), $linenumber, $output, 1);
      $output['pages'][3]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
    }
    if (strlen($data[$onair_index]['instructions']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index]['instructions']), $linenumber, $output, 1);
      $output['pages'][3]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
    }
    //$output .= "</page>\n";
  }
  $sub = 2;
  if (strlen($data[$onair_index_next]['description']) >= 1) {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 20; $i++) {
      $topspaces .= " ";
    }
    $output['pages'][4]['channel'] = $channel['main'];
    $output['pages'][4]['num'] = '101';
    $output['pages'][4]['sub'] = $sub_page;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext . $topspaces . $data[$onair_index]['start_time'] . '-' . $data[$onair_index]['end_time'];
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    /* $output .= "<page inserter=\"" . $channel['main'] . "\" num=\"101\" sub=\"" . $sub_page . "\" language=\"S\">\n";
      $output .= "<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . $data[$onair_index_next]['start_time'] . "-" . $data[$onair_index_next]['end_time'] . "</line>\n";
     */
    $linenumber = 3;

    if (strlen($data[$onair_index_next]['press_number']) >= 1) {
      $extratitle .= "(" . $data[$onair_index_next]['press_number'] . ") ";
    }
    if ($data[$onair_index_next]['repeat'] == "1" || trim($data[$onair_index_next]['repeat']) == "(G)") {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['title'] . $extratitle . " (G)"), $linenumber, $output, 0);
    }
    else {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['title'] . $extratitle), $linenumber, $output, 0);
    }
    $output['pages'][4]['lines'] = $result[1];
    //$output .= $result[1];
    $linenumber = $result[2];
    $linenumber += 1;

    $extra_row = 0;
    if (strlen($data[$onair_index_next]['genre']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['genre']), $linenumber, $output, 1);
      $output['pages'][4]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
      $extra_row = 1;
    }
    if ($data[$onair_index_next]['hd'] == "yes") {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish("(Kan ses i HD)"), $linenumber, $output, 1);
      $output['pages'][4]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
      $extra_row = 1;
    }
    if (strlen($data[$onair_index_next]['original_title']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['original_title']), $linenumber, $output, 1);
      $output['pages'][4]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
      $extra_row = 1;
    }
    if ($extra_row == 1) {
      $linenumber++;
    }

    $extra_line = 0;
    if (strlen($data[$onair_index_next]['actors']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['actors']), $extra_line, $output, 1);
      $extra_line = $result[2];
    }
    if (strlen($data[$onair_index_next]['instructions']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['instructions']), $extra_line, $output, 1);
      $extra_line = $result[2];
    }

    $line_text = "";
    $description = explode(".", _ttv_teletext_check_danish($data[$onair_index_next]['description']));
    $description_line_num = 0;
    $count = 0;
    foreach ($description as $text_num => $text) {
      $description2 = explode(" ", $text);
      foreach ($description2 as $text_num2 => $text2) {
        if (strlen($text2) >= 40) {
          # CUT EFTER 40 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
          if (strlen($line_text) >= 1) {
            $line_text .= " ";
          }
          $textlen = (37 - strlen($line_text));
          $line_text .= substr($text2, 0, (37 - strlen($line_text))) . "-";
          $description_line_num += 1;
          $line_text = substr($text2, (37 - strlen($line_text)), strlen($text2));
        }
        else {
          # HVIS $text2 + $line_text >= 40 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
          if ((strlen($text2) + strlen($line_text)) >= 39) {
            $description_line_num += 1;
            $line_text = $text2;
          }
          else {
            if (strlen($line_text) >= 1) {
              $line_text .= " ";
            }
            $line_text .= $text2;
          }
        }
      }
      if ($description_line_num <= (20 - $description_line_num - $extra_line)) {
        $count += 1;
      }
    }

    $line_text = "";
    for ($i = 1; $i <= $count; $i++) {
      $description2 = explode(" ", $description[($i - 1)] . ".");
      foreach ($description2 as $text_num2 => $text) {
        if (strlen($text) >= 1) {
          if (!(strlen($text) == 1 && stristr($text, "."))) {
            if (strlen($text) >= 40) {
              # CUT EFTER 40 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
              if (strlen($line_text) >= 1) {
                if (substr($line_text, -1) == "." && (!(is_numeric(substr(substr($line_text, -2), 0, 1))))) {
                  $line_text .= " ";
                }
                elseif (substr($line_text, -1) != ".") {
                  $line_text .= " ";
                }
              }
              $textlen = (37 - strlen($line_text));
              $line_text .= substr($text, 0, (37 - strlen($line_text))) . "-";
              $output['pages'][4]['lines'][$linenumber]['text'] = ($line_text);
              //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
              $linenumber += 1;
              $line_text = substr($text, (37 - strlen($line_text)), strlen($text));
            }
            else {
              # HVIS $text + $line_text >= 40 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
              if ((strlen($text) + strlen($line_text)) >= 39) {
                $output['pages'][4]['lines'][$linenumber]['text'] = ($line_text);
                //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
                $linenumber += 1;
                $line_text = $text;
              }
              else {
                if (strlen($line_text) >= 1) {
                  if (substr($line_text, -1) == "." && (!(is_numeric(substr(substr($line_text, -2), 0, 1))))) {
                    $line_text .= " ";
                  }
                  elseif (substr($line_text, -1) != ".") {
                    $line_text .= " ";
                  }
                }
                $line_text .= $text;
                //check what happens here
              }
            }
          }
        }
      }
    }
    $output['pages'][4]['lines'][$linenumber]['text'] = ($line_text);
    //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
    $linenumber += 1;

    if (strlen($data[$onair_index_next]['actors']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['actors']), $linenumber, $output, 1);
      $output['pages'][4]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
    }
    if (strlen($data[$onair_index_next]['instructions']) >= 1) {
      $result = _ttv_teletext_cuttext(_ttv_teletext_check_danish($data[$onair_index_next]['instructions']), $linenumber, $output, 1);
      $output['pages'][4]['lines'] = $result[1];
      //$output .= $result[1];
      $linenumber = $result[2];
    }
    //$output .= "</page>\n";
  }

  //$xml .= "<page inserter=\"" . $channel['main'] . "\" num=\"100\" sub=\"1\" language=\"S\">\n";
  $output['pages'][5]['channel'] = $channel['main'];
  $output['pages'][5]['num'] = '100';
  $output['pages'][5]['sub'] = '1';
  $output['pages'][5]['lang'] = 'S';

  $output['pages'][5]['lines'][6]['color'] = 'white';
  $output['pages'][5]['lines'][6]['text'] = $data[$onair_index]['start_time'] . "<cyan/>" . $current_program_onair_text_split['line'][0] . "<yellow/>" . $current_program_onair_text_split['properties']['spaces'] . $onair_ttv_text;

  $output['pages'][5]['lines'][7]['color'] = '';
  $output['pages'][5]['lines'][7]['text'] = "<holdgraph/>" . $program_red . $program_yellow . "<yellow/> Tid tilbage";

  $output['pages'][5]['lines'][8]['color'] = 'white';
  $output['pages'][5]['lines'][8]['text'] = $data[$onair_index_next]['start_time'] . "<cyan/>" . $next_program_onair_text_split['line'][0] . "<yellow/>" . $next_program_onair_text_split['properties']['spaces'] . $onair_next_ttv_text;

  /* $output2 = "<line num=\"6\"><white/>" . $data[$onair_index]['start_time'] . "<cyan/>" . $current_program_onair_text_split['line'][0] . "<yellow/>" . $current_program_onair_text_split['properties']['spaces'] . $onair_ttv_text . "</line>\n";
    $output2 .= "<line num=\"7\">     <holdgraph/>" . $program_red . $program_yellow . "<yellow/> Tid tilbage</line>\n";
    $output2 .= "<line num=\"8\"><white/>" . $data[$onair_index_next]['start_time'] . "<cyan/>" . $next_program_onair_text_split['line'][0] . "<yellow/>" . $next_program_onair_text_split['properties']['spaces'] . $onair_next_ttv_text . "</line>\n";
   */
  $current_program_onair_newtime[0] = $data[$onair_index]['start_time'];

  $channel_tid = 2; //kanal5
  $data1 = _ttv_teletext_get_data($date, $channel[1], '05:56:00');

  $current_time = date('H:i:s');
  foreach ($data1 as $k => $v) {
    if (($v['start_time'] < $current_time) && ($v['end_time'] > $current_time) && ($v['start_time'] != $v['end_time'])) {
      $data1[$k]['onair'] = TRUE;
    }
    else {
      $data1[$k]['onair'] = FALSE;
    }
  }

  //find current program on air
  foreach ($data1 as $k => $v) {
    if ($v['onair']) {
      $onair_index = $k;
    }
  }
  //create current program text
  if ($data1[$onair_index]['hd'] == 'yes') {
    $hdtext = "(HD) ";
  }
  else {
    $hdtext = "";
  }
  if ($data1[$onair_index]['local'] == 'yes') {
    $localtext = "/lok. prg. ";
  }
  else {
    $localtext = "";
  }
  $extratitle = "";
  if ($data1[$onair_index]['repeat'] != 0 && $data1[$onair_index]['repeat'] != "" && $data1[$onair_index]['repeat'] != "1" && trim($data1[$onair_index]['repeat']) != "(G)") {
    $current_program_onair_text = _ttv_teletext_check_danish($data1[$onair_index]['title'] . " " . $extratitle . $hdtekst . $data1[$onair_index]['repeat'] . $localtekst . " NEWLINE " . $data1[$onair_index]['genre']);
  }
  else {
    if ($data1[$onair_index]['repeat'] == "1" || trim($data1[$onair_index]['repeat']) == "(G)") {
      $current_program_onair_text = _ttv_teletext_check_danish($data1[$onair_index]['title'] . " " . $extratitle . $hdtext . "(G) " . $localtext . "NEWLINE " . $data1[$onair_index]['genre']);
    }
    else {
      $current_program_onair_text = _ttv_teletext_check_danish($data1[$onair_index]['title'] . " " . $extratitle . $hdtext . $localtext . "NEWLINE " . $data1[$onair_index]['genre']);
    }
  }
  $onair_index_next = $onair_index + 1;
  if ($onair_index_next > count($data1)) {
    //HANDLE EXTREME FRINGE CASE WHERE NEXT PROGRAM IS THE FIRST PROGRAM FROM THE NEXT DAY
  }
  else {
    //create next program text
    if ($data1[$onair_index_next]['hd'] == 'yes') {
      $hdtext = "(HD) ";
    }
    else {
      $hdtext = "";
    }
    if ($data1[$onair_index_next]['local'] == 'yes') {
      $localtext = "/lok. prg. ";
    }
    else {
      $localtext = "";
    }
    $extratitle = "";
    if ($data1[$onair_index_next]['repeat'] != 0 && $data1[$onair_index_next]['repeat'] != "" && $data1[$onair_index_next]['repeat'] != "1" && trim($data1[$onair_index_next]['repeat']) != "(G)") {
      $next_program_onair_text = _ttv_teletext_check_danish($data1[$onair_index_next]['title'] . " " . $extratitle . $hdtekst . $data1[$onair_index_next]['repeat'] . $localtekst . " NEWLINE " . $data1[$onair_index_next]['genre']);
    }
    else {
      if ($data1[$onair_index_next]['repeat'] == "1" || trim($data1[$onair_index_next]['repeat']) == "(G)") {
        $next_program_onair_text = _ttv_teletext_check_danish($data1[$onair_index_next]['title'] . " " . $extratitle . $hdtext . "(G) " . $localtext . "NEWLINE " . $data1[$onair_index_next]['genre']);
      }
      else {
        $next_program_onair_text = _ttv_teletext_check_danish($data1[$onair_index_next]['title'] . " " . $extratitle . $hdtext . $localtext . "NEWLINE " . $data1[$onair_index_next]['genre']);
      }
    }
  }
  $current_program_onair_text_split['line'] = _ttv_teletext_split_2lines($current_program_onair_text);
  $next_program_onair_text_split['line'] = _ttv_teletext_split_2lines($next_program_onair_text);

  $current_program_onair_text_split['line'][0] = str_replace("NEWLINEDONE", "", $current_program_onair_text_split['line'][0]);

  $current_program_onair_text_split['properties']['lenght'] = 29 - strlen($current_program_onair_text_split['line'][0]);
  $current_program_onair_text_split['properties']['spaces'] = "";
  for ($i = 1; $i <= $current_program_onair_text_split['properties']['lenght']; $i++) {
    $current_program_onair_text_split['properties']['spaces'] .= " ";
  }

  $next_program_onair_text_split['line'][0] = str_replace("NEWLINEDONE", "", $next_program_onair_text_split['line'][0]);

  $output['pages'][5]['lines'][10]['color'] = 'white';
  $output['pages'][5]['lines'][10]['text'] = $channel['sub1'] . " Nu:   " . $current_program_onair_text_split['line'][0];

  $output['pages'][5]['lines'][11]['color'] = 'white';
  $output['pages'][5]['lines'][11]['text'] = $channel['sub1'] . " " . $data1[$onair_index_next]['start_time'] . " " . $next_program_onair_text_split['line'][0];

  /* $output2 .= "<line num=\"10\"><white/>" . $channel['sub1'] . " Nu:   " . $current_program_onair_text_split['line'][0] . "</line>\n";
    $output2 .= "<line num=\"11\"><white/>" . $channel['sub1'] . " " . $data1[$onair_index_next]['start_time'] . " " . $next_program_onair_text_split['line'][0] . "</line>\n";
   */

  $current_program_onair_newtime[1] = $data1[$onair_index]['start_time'];


  $channel_tid = 3; //6eren
  $data2 = _ttv_teletext_get_data($date, $channel[2], '05:56:00');

  $current_time = date('H:i:s');
  foreach ($data2 as $k => $v) {
    if (($v['start_time'] < $current_time) && ($v['end_time'] > $current_time) && ($v['start_time'] != $v['end_time'])) {
      $data2[$k]['onair'] = TRUE;
    }
    else {
      $data2[$k]['onair'] = FALSE;
    }
  }

  //find current program on air
  foreach ($data2 as $k => $v) {
    if ($v['onair']) {
      $onair_index = $k;
    }
  }
  //create current program text
  if ($data2[$onair_index]['hd'] == 'yes') {
    $hdtext = "(HD) ";
  }
  else {
    $hdtext = "";
  }
  if ($data2[$onair_index]['local'] == 'yes') {
    $localtext = "/lok. prg. ";
  }
  else {
    $localtext = "";
  }
  $extratitle = "";
  if ($data2[$onair_index]['repeat'] != 0 && $data2[$onair_index]['repeat'] != "" && $data2[$onair_index]['repeat'] != "1" && trim($data2[$onair_index]['repeat']) != "(G)") {
    $current_program_onair_text = _ttv_teletext_check_danish($data2[$onair_index]['title'] . " " . $extratitle . $hdtekst . $data2[$onair_index]['repeat'] . $localtekst . " NEWLINE " . $data2[$onair_index]['genre']);
  }
  else {
    if ($data2[$onair_index]['repeat'] == "1" || trim($data2[$onair_index]['repeat']) == "(G)") {
      $current_program_onair_text = _ttv_teletext_check_danish($data2[$onair_index]['title'] . " " . $extratitle . $hdtext . "(G) " . $localtext . "NEWLINE " . $data2[$onair_index]['genre']);
    }
    else {
      $current_program_onair_text = _ttv_teletext_check_danish($data2[$onair_index]['title'] . " " . $extratitle . $hdtext . $localtext . "NEWLINE " . $data2[$onair_index]['genre']);
    }
  }
  $onair_index_next = $onair_index + 1;
  if ($onair_index_next > count($data2)) {
    //HANDLE EXTREME FRINGE CASE WHERE NEXT PROGRAM IS THE FIRST PROGRAM FROM THE NEXT DAY
  }
  else {
    //create next program text
    if ($data2[$onair_index_next]['hd'] == 'yes') {
      $hdtext = "(HD) ";
    }
    else {
      $hdtext = "";
    }
    if ($data2[$onair_index_next]['local'] == 'yes') {
      $localtext = "/lok. prg. ";
    }
    else {
      $localtext = "";
    }
    $extratitle = "";
    if ($data2[$onair_index_next]['repeat'] != 0 && $data2[$onair_index_next]['repeat'] != "" && $data2[$onair_index_next]['repeat'] != "1" && trim($data2[$onair_index_next]['repeat']) != "(G)") {
      $next_program_onair_text = _ttv_teletext_check_danish($data2[$onair_index_next]['title'] . " " . $extratitle . $hdtekst . $data2[$onair_index_next]['repeat'] . $localtekst . " NEWLINE " . $data2[$onair_index_next]['genre']);
    }
    else {
      if ($data2[$onair_index_next]['repeat'] == "1" || trim($data2[$onair_index_next]['repeat']) == "(G)") {
        $next_program_onair_text = _ttv_teletext_check_danish($data2[$onair_index_next]['title'] . " " . $extratitle . $hdtext . "(G) " . $localtext . "NEWLINE " . $data2[$onair_index_next]['genre']);
      }
      else {
        $next_program_onair_text = _ttv_teletext_check_danish($data2[$onair_index_next]['title'] . " " . $extratitle . $hdtext . $localtext . "NEWLINE " . $data2[$onair_index_next]['genre']);
      }
    }
  }
  $current_program_onair_text_split['line'] = _ttv_teletext_split_2lines($current_program_onair_text);
  $next_program_onair_text_split['line'] = _ttv_teletext_split_2lines($next_program_onair_text);

  $current_program_onair_text_split['line'][0] = str_replace("NEWLINEDONE", "", $current_program_onair_text_split['line'][0]);

  $current_program_onair_text_split['properties']['lenght'] = 29 - strlen($current_program_onair_text_split['line'][0]);
  $current_program_onair_text_split['properties']['spaces'] = "";
  for ($i = 1; $i <= $current_program_onair_text_split['properties']['lenght']; $i++) {
    $current_program_onair_text_split['properties']['spaces'] .= " ";
  }

  $next_program_onair_text_split['line'][0] = str_replace("NEWLINEDONE", "", $next_program_onair_text_split['line'][0]);

  $output['pages'][5]['lines'][12]['color'] = 'white';
  $output['pages'][5]['lines'][12]['text'] = $channel['sub2'] . "  Nu:   " . $current_program_onair_text_split['line'][0];

  $output['pages'][5]['lines'][13]['color'] = 'white';
  $output['pages'][5]['lines'][13]['text'] = $channel['sub2'] . "  " . $data2[$onair_index_next]['start_time'] . " " . $next_program_onair_text_split['line'][0];

  /*
    $output2 .= "<line num=\"12\"><white/>" . $channel['sub2'] . "  Nu:   " . $current_program_onair_text_split['line'][0] . "</line>\n";
    $output2 .= "<line num=\"13\"><white/>" . $channel['sub2'] . "  " . $data2[$onair_index_next]['start_time'] . " " . $next_program_onair_text_split['line'][0] . "</line>\n";
   */
  $current_program_onair_newtime[2] = $data2[$onair_index]['start_time'];

  //build the xml

  $variables['output'] = $output;
  $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n";
  $xml .= theme('pages_100_101', $variables);




  /* $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>;
    <teletext user=\"propeople\" pass=\"tvdanmark\">\n";
    $xml .= $output;
    $xml .= "<page inserter=\"" . $channel['main'] . "\" num=\"100\" sub=\"1\" language=\"S\">\n";
    $xml .= $output2;
    $xml .= "</page>\n
    </teletext>";

    str_replace("<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>", "", $xml) . "<br>";
   */
  //$xml = mb_convert_encoding($xml, "iso-8859-1");

  print $xml;
  //_ttv_teletext_send_curl($xml);
}

/*
 * Helper function to convert dates to Danish
 */

function _ttv_teletext_datetext($date) {
  $datetext = date("l d. F", strtotime($date));
  $datetext = str_replace("Monday", "Mandag", $datetext);
  $datetext = str_replace("Tuesday", "Tirsdag", $datetext);
  $datetext = str_replace("Wednesday", "Onsdag", $datetext);
  $datetext = str_replace("Thursday", "Torsdag", $datetext);
  $datetext = str_replace("Friday", "Fredag", $datetext);
  $datetext = str_replace("Saturday", "Lørdag", $datetext);
  $datetext = str_replace("Sunday", "Søndag", $datetext);

  $datetext = str_replace("January", "januar", $datetext);
  $datetext = str_replace("February", "februar", $datetext);
  $datetext = str_replace("March", "marts", $datetext);
  $datetext = str_replace("April", "april", $datetext);
  $datetext = str_replace("May", "maj", $datetext);
  $datetext = str_replace("June", "juni", $datetext);
  $datetext = str_replace("July", "juli", $datetext);
  $datetext = str_replace("August", "august", $datetext);
  $datetext = str_replace("September", "september", $datetext);
  $datetext = str_replace("October", "oktober", $datetext);
  $datetext = str_replace("November", "november", $datetext);
  $datetext = str_replace("December", "december", $datetext);
  return $datetext;
}

/*
 * Helper function to fix special Danish letters
 */

function _ttv_teletext_check_danish($sString) {
  $sString1 = str_replace("&", "og", $sString);
  $sString1 = str_replace("", "&#230;", $sString1);
  $sString1 = str_replace("", "&#248;", $sString1);
  $sString1 = str_replace("og#230;", "&#230;", $sString1);
  $sString1 = str_replace("og#248;", "&#248;", $sString1);
  $sString1 = str_replace("	 ", " ", $sString1);
  $sString1 = str_replace("ÃŒ", "ü", $sString1);
  $sString1 = str_replace("Ã¶", "ö", $sString1);
  $sString1 = str_replace("ð", "-", $sString1);
  $sString1 = str_replace("ÃŠ", "æ", $sString1);
  $sString1 = str_replace("Ãž", "ø", $sString1);
  $sString1 = str_replace("Ã¥", "å", $sString1);
  $sString1 = str_replace("Ãå", "Æ", $sString1);
  $sString1 = str_replace("Ãž", "Ø", $sString1);
  $sString1 = str_replace("Ã", "Å", $sString1);
  $sString1 = str_replace("Ã", "Ø", $sString1);
  $sString1 = str_replace("â", ",", $sString1);
  return $sString1;
}

/*
 * Helper function to split program text into 2 lines
 */

function _ttv_teletext_split_2lines($text) {
  $text = explode(" ", $text);
  $line1 = '';
  $line2 = '';
  $flag = 0;
  foreach ($text as $num => $t) {
    if (strlen($line1) == 0) {
      $line1 = $t;
    }
    elseif ($t == "NEWLINE") {
      $line1 .= "NEWLINEDONE";
    }
    else {
      if ((strlen($line1) + strlen($t)) <= 26 && strlen($line2) == 0 && (!(stristr($line1, "NEWLINEDONE")))) {
        $line1 .= " " . $t;
      }
      else {
        if (strlen($line2) == 0) {
          if (strlen($t) <= 33) {
            $line2 = $t;
          }
          else {
            $line2 = substr($t, 0, 33);
          }
        }
        else {
          if ((strlen($line2) + strlen($t)) <= 32 && $flag == 0) {
            $line2 .= " " . $t;
          }
          else {
            $flag = 1;
          }
        }
      }
    }
  }
  return array($line1, $line2);
}

//checked logic, using as black box
function _ttv_teletext_cuttext($text, $linenumber, $tekstpages, $color) {
  $temp = array();
  if ($color == 1) {
    $colortext = "yellow";
  }
  else {
    $colortext = "cyan";
  }
  if (!isset($colortext)) {
    $colortext = "white";
  }
  $programtitle = explode(" ", $text);
  $linetekst = "";
  $tekstpages = "";
  foreach ($programtitle as $tekst_num => $tekst) {
    if (strlen($tekst) >= 40) {
      # CUT EFTER 40 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
      if (strlen($linetekst) >= 1) {
        $linetekst .= " ";
      }
      $textlen = (37 - strlen($linetekst));
      $linetekst .= substr($tekst, 0, $textlen) . "-";
      $temp[$linenumber]['color'] = $colortext;
      $temp[$linenumber]['text'] = $linetekst;
      //$tekstpages .= "<line num=\"" . $linenumber . "\"><" . $colortext . "/>" . $linetekst . "</line>\n";
      $linenumber += 1;
      $linetekst = substr($tekst, $textlen, strlen($tekst));
    }
    else {
      # HVIS $tekst + $linetekst >= 40 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
      if ((strlen($tekst) + strlen($linetekst)) >= 39) {
        $temp[$linenumber]['color'] = $colortext;
        $temp[$linenumber]['text'] = $linetekst;
        //$tekstpages .= "<line num=\"" . $linenumber . "\"><" . $colortext . "/>" . $linetekst . "</line>\n";
        $linenumber += 1;
        $linetekst = $tekst;
      }
      else {
        if (strlen($linetekst) >= 1) {
          $linetekst .= " ";
        }
        $linetekst .= $tekst;
      }
    }
  }
  $temp[$linenumber]['color'] = $colortext;
  $temp[$linenumber]['text'] = $linetekst;
  //$tekstpages .= "<line num=\"" . $linenumber . "\"><" . $colortext . "/>" . $linetekst . "</line>\n";
  $linenumber += 1;
  $output1 = array();
  $output1[1] = $temp;
  $output1[2] = $linenumber;
  return $output1;
}

/*
 * Helper function for getting data from the database
 */

function _ttv_teletext_get_data($date, $channel_tid, $start_time_of_day) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'program')
      ->propertyCondition('status', 1)
      ->fieldCondition('field_channeldate', 'value', $date, '=')
      ->fieldCondition('field_channel', 'tid', $channel_tid, '=')
      ->fieldCondition('field_starttime', 'value', $start_time_of_day, '>')
      ->fieldOrderBy('field_starttime', 'value', 'ASC');
  $result = $query->execute();
  if (!empty($result)) {
    foreach ($result as $k => $v) {
      foreach ($v as $k1 => $v1) {
        $node_data[] = node_load($v1->nid);
      }
    }
  }
  else {
    drupal_set_message('No nodes found for the requested channel. Aborting!', 'error');
    drupal_set_message('<i>You need valid nodes with programs data to generate teletext output!</i>', 'warning');
    drupal_goto('teletext-list');
  }
  $query1 = new EntityFieldQuery();
  $query1->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'program')
      ->propertyCondition('status', 1)
      ->fieldCondition('field_channeldate', 'value', $date, '=')
      ->fieldCondition('field_channel', 'tid', $channel_tid, '=')
      ->fieldCondition('field_starttime', 'value', $start_time_of_day, '<')
      ->fieldOrderBy('field_starttime', 'value', 'ASC');
  $result1 = $query1->execute();
  if (!empty($result1)) {
    foreach ($result1 as $k => $v) {
      foreach ($v as $k1 => $v1) {
        $node_data1[] = node_load($v1->nid);
      }
    }
  }
  else {
    drupal_set_message('No nodes found for the requested channel. Aborting!', 'error');
    drupal_set_message('<i>You need valid nodes with programs data to generate teletext output!</i>', 'warning');
    drupal_goto('teletext-list');
  }
  $index = 1;
  foreach ($node_data as $k => $v) {
    $data[$index]['program_id'] = $v->nid;
    $data[$index]['title'] = $v->title;
    if (!empty($v->field_originaltitle['und'][0]['value'])) {
      $data[$index]['original_title'] = $v->field_originaltitle['und'][0]['value'];
    }
    else {
      $data[$index]['original_title'] = '';
    }
    if (!empty($v->body['und'][0]['value'])) {
      $data[$index]['description'] = $v->body['und'][0]['value'];
    }
    else {
      $data[$index]['description'] = 'Ingen beskrivelse.';
    }
    $data[$index]['channel_id'] = $v->field_channel['und'][0]['tid'];
    $data[$index]['channel_date'] = $v->field_channeldate['und'][0]['value'];
    $data[$index]['start_time'] = $v->field_starttime['und'][0]['value'];
    $data[$index]['actual_start_time'] = $v->field_actualstarttime['und'][0]['value'];
    $data[$index]['end_time'] = $v->field_endtime['und'][0]['value'];
    if (!empty($v->field_actors['und'][0]['value'])) {
      $data[$index]['actors'] = $v->field_actors['und'][0]['value'];
    }
    else {
      $data[$index]['actors'] = '';
    }
    if (!empty($v->field_instructions['und'][0]['value'])) {
      $data[$index]['instructions'] = $v->field_instructions['und'][0]['value'];
    }
    else {
      $data[$index]['instructions'] = '';
    }
    if (!empty($v->field_genre['und'][0]['value'])) {
      $data[$index]['genre'] = $v->field_genre['und'][0]['value'];
    }
    else {
      $data[$index]['genre'] = '';
    }
    if (!empty($v->field_pressnumber['und'][0]['value'])) {
      $data[$index]['press_number'] = $v->field_pressnumber['und'][0]['value'];
    }
    else {
      $data[$index]['press_number'] = '';
    }
    $data[$index]['hd'] = $v->field_hd['und'][0]['value'];
    $data[$index]['local'] = $v->field_localprogram['und'][0]['value'];
    if (!empty($v->field_ttvtext['und'][0]['value'])) {
      $data[$index]['ttv'] = $v->field_ttvtext['und'][0]['value'];
    }
    else {
      $data[$index]['ttv'] = NULL;
    }
    $data[$index]['repeat'] = $v->field_repeat['und'][0]['value'];
    $index++;
  }

  foreach ($node_data1 as $k => $v) {
    $data[$index]['program_id'] = $v->nid;
    $data[$index]['title'] = $v->title;
    if (!empty($v->field_originaltitle['und'][0]['value'])) {
      $data[$index]['original_title'] = $v->field_originaltitle['und'][0]['value'];
    }
    else {
      $data[$index]['original_title'] = '';
    }
    if (!empty($v->body['und'][0]['value'])) {
      $data[$index]['description'] = $v->body['und'][0]['value'];
    }
    else {
      $data[$index]['description'] = 'Ingen beskrivelse.';
    }
    $data[$index]['channel_id'] = $v->field_channel['und'][0]['tid'];
    $data[$index]['channel_date'] = $v->field_channeldate['und'][0]['value'];
    $data[$index]['start_time'] = $v->field_actualstarttime['und'][0]['value'];
    $data[$index]['actual_start_time'] = $v->field_actualstarttime['und'][0]['value'];
    if (!empty($v->field_actors['und'][0]['value'])) {
      $data[$index]['actors'] = $v->field_actors['und'][0]['value'];
    }
    else {
      $data[$index]['actors'] = '';
    }
    if (!empty($v->field_instructions['und'][0]['value'])) {
      $data[$index]['instructions'] = $v->field_instructions['und'][0]['value'];
    }
    else {
      $data[$index]['instructions'] = '';
    }
    if (!empty($v->field_genre['und'][0]['value'])) {
      $data[$index]['genre'] = $v->field_genre['und'][0]['value'];
    }
    else {
      $data[$index]['genre'] = '';
    }
    if (!empty($v->field_pressnumber['und'][0]['value'])) {
      $data[$index]['press_number'] = $v->field_pressnumber['und'][0]['value'];
    }
    else {
      $data[$index]['press_number'] = '';
    }
    $data[$index]['end_time'] = $v->field_endtime['und'][0]['value'];
    $data[$index]['hd'] = $v->field_hd['und'][0]['value'];
    $data[$index]['local'] = $v->field_localprogram['und'][0]['value'];
    if (!empty($v->field_ttvtext['und'][0]['value'])) {
      $data[$index]['ttv'] = $v->field_ttvtext['und'][0]['value'];
    }
    else {
      $data[$index]['ttv'] = NULL;
    }
    $data[$index]['repeat'] = $v->field_repeat['und'][0]['value'];
    $index++;
  }
  // set end times
  for ($i = 1; $i < count($data); $i++) {
    $data[$i]['end_time'] = $data[$i + 1]['start_time'];
  }
  $data[$i]['end_time'] = $data[1]['start_time'];
  return $data;
}

/*
 * Helper function to determine channel order of displaying
 */

function _ttv_teletext_determine_channel_order($channel_tid) {
  switch ($channel_tid) {
    case 1: //order = k4, k5, 6eren
      $channel[0] = $channel_tid;
      $channel[1] = $channel_tid + 1;
      $channel[2] = $channel_tid + 2;
      $channel['main'] = 'KANAL4';
      $channel['sub1'] = 'Kanal 5';
      $channel['sub2'] = '6\'eren';
      break;
    case 2: //order = k5, k4, 6eren
      $channel[0] = $channel_tid;
      $channel[1] = $channel_tid - 1;
      $channel[2] = $channel_tid + 1;
      $channel['main'] = 'KANAL5';
      $channel['sub1'] = 'Kanal 4';
      $channel['sub2'] = '6\'eren';
      break;
    case 3: //order = 6eren, k4, k5
      $channel[0] = $channel_tid;
      $channel[1] = $channel_tid - 2;
      $channel[2] = $channel_tid - 1;
      $channel['main'] = 'SBSNET';
      $channel['sub1'] = 'Kanal 4';
      $channel['sub2'] = 'Kanal 5';
      break;
  }
  return $channel;
}

/*
 * Helper function to send data to Phoenix server
 */

function _ttv_teletext_send_curl($xml) {
  return;
  $url_to_phoenix = ''; //http://77.247.69.70:8080/ttvxml/
  $header = array(
    "Content-type: application/x-www-form-urlencoded;"
  );

  $data = "xml=" . urlencode($xml);

  $handler = curl_init();
  curl_setopt($handler, CURLOPT_URL, $url_to_phoenix);
  curl_setopt($handler, CURLOPT_POSTFIELDS, $data);
  curl_setopt($handler, CURLOPT_HEADER, 0);
  curl_setopt($handler, CURLOPT_POST, 1);
  curl_setopt($handler, CURLOPT_SSL_VERIFYPEER, FALSE);
  curl_setopt($handler, CURLOPT_HTTPHEADER, $header);
  curl_setopt($handler, CURLOPT_RETURNTRANSFER, 1);
  $result = curl_exec($handler);
 if ($result === FALSE) {
    $last_mail_timestamp = variable_get('sent_mail_flag_curl', 0);
    $current_time = time();
    $default_email = variable_get('site_mail', ''); 
    if(($current_time-86400) > $last_mail_timestamp) {
      $language = language_default();
      $params = array(
        'uri' => $url_to_phoenix,
        'data' => $data,
      );
      drupal_mail('ttv_teletext', 'teletext', variable_get('list_of_receivers', $default_email), $language, $params, '', TRUE);
      
      variable_set('sent_mail_flag_curl', $current_time);
    }
  }
  print str_replace("<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>", "", $result);
  curl_close($handler);
}

/*
 * Helper function to build xml - kanal4 specific
 */

function _ttv_teletext_build_kanal4_pages($station, $date, $datetext, $page, $pagetype, $ttvundersider) {
  $channel_tid = 1;
  if ($pagetype == 0) {
    $pagenum1 = $page;
    $pagenum2 = $pagenum1 + 1;
    $pagenum3 = $pagenum2 + 1;
    $pagenum4 = $pagenum3 + 1;
    $pagesub1 = 1;
    $pagesub2 = 1;
    $pagesub3 = 1;
    $pagesub4 = 1;
  }
  else {
    $pagenum1 = $page;
    $pagenum2 = $page;
    $pagenum3 = $page;
    $pagenum4 = $page;
    $pagesub1 = 1;
    $pagesub2 = 2;
    $pagesub3 = 3;
    $pagesub4 = 4;
  }
  if ($station == "Kanal 5") {
    $tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  elseif ($station == "6eren") {
    if (date("Ymd") >= 20090101) {
      $tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
    }
    else {
      $tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
    }
  }
  elseif ($station == "Kanal 4 Østjylland") {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 23; $i++) {
      $topspaces .= " ";
    }
    $tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
  }
  elseif ($station == "Kanal 4 Aalborg") {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 24; $i++) {
      $topspaces .= " ";
    }
    $tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
  }
  elseif ($station == "Kanal 4 Fyn") {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 28; $i++) {
      $topspaces .= " ";
    }
    $tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
  }
  else {
    $tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  $linenumber1 = 3;
  $linenumber2 = 3;
  $linenumber3 = 3;
  $linenumber4 = 3;

  $data = _ttv_teletext_get_data($date, $channel_tid, '05:56:00');
  foreach ($data as $k => $v) {
    $starttid = substr($v['start_time'], 0, 5);
    $starttid = str_replace(":", "", $starttid);
    $side = "";
    if ($ttvundersider == 1) {
      if (!empty($v['ttv'])) {
        $side = $v['ttv'];
      }
    }
    $newlinenum = 1;

    $linetekst = "";
    $gotext = "";
    if ($v['hd'] == "yes") {
      $hdtekst = "(HD) ";
    }
    else {
      $hdtekst = "";
    }
    if ($v['local'] == 'yes') {
      $localtekst = "/lok. prg. ";
    }
    else {
      $localtekst = "";
    }
    $extratitle = "";
    if ($v['repeat'] == 'yes' || trim($v['repeat']) == "(G)") {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst)));
      }
    }
    else {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . $localtekst)));
      }
    }
    foreach ($programtitle as $tekst_num => $tekst) {
      if (strlen($tekst) >= 30) {
        # CUT EFTER 29 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
        if (strlen($linetekst) >= 1) {
          $linetekst .= " ";
        }
        $textlen = (27 - strlen($linetekst));
        $linetekst .= substr($tekst, 0, $textlen) . "-";
        $gotext .= ($linetekst);
        $linetekst = substr($tekst, $textlen, strlen($tekst));
      }
      elseif ($tekst == "NEWLINE") {
        $gotext .= ($linetekst);
        $linetekst = "";
      }
      else {
        # HVIS $tekst + $linetekst >= 29 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
        if ((strlen($tekst) + strlen($linetekst)) >= 29) {
          $gotext .= ($linetekst);
          $linetekst = $tekst;
        }
        else {
          if (strlen($linetekst) >= 1) {
            $linetekst .= " ";
          }
          $linetekst .= $tekst;
        }
      }
      if (strlen($gotext) >= 1) {
        if ($newlinenum == 1) {
          $spaces = "";
          for ($i = strlen($gotext); $i <= 28; $i++) {
            $spaces .= " ";
          }
          if ($starttid >= 556 && $starttid <= 1159) {
            $tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          else {
            $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
        }
        else {
          if ($starttid >= 556 && $starttid <= 1159) {
            $tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          else {
            $tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $linenumber1 += 1;
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $linenumber2 += 1;
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $linenumber3 += 1;
        }
        else {
          $linenumber4 += 1;
          $endtime = $v['end_time'];
        }
        $newlinenum += 1;
        $gotext = "";
      }
    }
    if (strlen($linetekst) >= 1) {
      if ($newlinenum == 1) {
        $spaces = "";
        for ($i = strlen($linetekst); $i <= 28; $i++) {
          $spaces .= " ";
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        else {
          $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
      }
      else {
        if ($starttid >= 556 && $starttid <= 1159) {
          $tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        else {
          $tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
      }
      if ($starttid >= 556 && $starttid <= 1159) {
        $linenumber1 += 1;
      }
      elseif ($starttid >= 1200 && $starttid <= 1759) {
        $linenumber2 += 1;
      }
      elseif ($starttid >= 1800 && $starttid <= 2259) {
        $linenumber3 += 1;
      }
      else {
        $linenumber4 += 1;
        $endtime = $v['end_time'];
      }
      $newlinenum += 1;
      $gotext = "";
    }
  }

  $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $endtime . "<cyan/>Godnat</line>\n";
  $tekstpage1 .= "</page>\n";
  $tekstpage2 .= "</page>\n";
  $tekstpage3 .= "</page>\n";
  $tekstpage4 .= "</page>\n";

  $output = array();
  $output[1] = $tekstpage1;
  $output[2] = $tekstpage2;
  $output[3] = $tekstpage3;
  $output[4] = $tekstpage4;
  return $output;
}

/*
 * Helper function to build xml - kanal5 specific
 */

function _ttv_teletext_build_kanal5_pages($station, $date, $datetext, $page, $pagetype, $ttvundersider) {
  $channel_tid = 2;
  if ($pagetype == 0) {
    $pagenum1 = $page;
    $pagenum2 = $pagenum1 + 1;
    $pagenum3 = $pagenum2 + 1;
    $pagenum4 = $pagenum3 + 1;
    $pagesub1 = 1;
    $pagesub2 = 1;
    $pagesub3 = 1;
    $pagesub4 = 1;
  }
  else {
    $pagenum1 = $page;
    $pagenum2 = $page;
    $pagenum3 = $page;
    $pagenum4 = $page;
    $pagesub1 = 1;
    $pagesub2 = 2;
    $pagesub3 = 3;
    $pagesub4 = 4;
  }
  if ($station == "Kanal 5") {
    $tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  elseif ($station == "Kanal 4") {
    $tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  elseif ($station == "6eren") {
    if (date("Ymd") >= 20090101) {
      $tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
    }
    else {
      $tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
    }
  }
  else {
    $tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  $linenumber1 = 3;
  $linenumber2 = 3;
  $linenumber3 = 3;
  $linenumber4 = 3;

  $data = _ttv_teletext_get_data($date, $channel_tid, '05:56:00');
  foreach ($data as $k => $v) {
    $starttid = substr($v['start_time'], 0, 5);
    $starttid = str_replace(":", "", $starttid);
    $side = "";
    if ($ttvundersider == 1) {
      if (!empty($v['ttv'])) {
        $side = $v['ttv'];
      }
    }
    $newlinenum = 1;

    $linetekst = "";
    $gotext = "";
    if ($v['hd'] == "yes") {
      $hdtekst = "(HD) ";
    }
    else {
      $hdtekst = "";
    }
    if ($v['local'] == 'yes') {
      $localtekst = "/lok. prg. ";
    }
    else {
      $localtekst = "";
    }
    $extratitle = "";
    if ($v['repeat'] == 'yes' || trim($v['repeat']) == "(G)") {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst)));
      }
    }
    else {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . $localtekst)));
      }
    }
    foreach ($programtitle as $tekst_num => $tekst) {
      if (strlen($tekst) >= 30) {
        # CUT EFTER 29 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
        if (strlen($linetekst) >= 1) {
          $linetekst .= " ";
        }
        $textlen = (27 - strlen($linetekst));
        $linetekst .= substr($tekst, 0, $textlen) . "-";
        $gotext .= ($linetekst);
        $linetekst = substr($tekst, $textlen, strlen($tekst));
      }
      elseif ($tekst == "NEWLINE") {
        $gotext .= ($linetekst);
        $linetekst = "";
      }
      else {
        # HVIS $tekst + $linetekst >= 29 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
        if ((strlen($tekst) + strlen($linetekst)) >= 29) {
          $gotext .= ($linetekst);
          $linetekst = $tekst;
        }
        else {
          if (strlen($linetekst) >= 1) {
            $linetekst .= " ";
          }
          $linetekst .= $tekst;
        }
      }
      if (strlen($gotext) >= 1) {
        if ($newlinenum == 1) {
          $spaces = "";
          for ($i = strlen($gotext); $i <= 28; $i++) {
            $spaces .= " ";
          }
          if ($starttid >= 556 && $starttid <= 1159) {
            $tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          else {
            $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
        }
        else {
          if ($starttid >= 556 && $starttid <= 1159) {
            $tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          else {
            $tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $linenumber1 += 1;
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $linenumber2 += 1;
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $linenumber3 += 1;
        }
        else {
          $linenumber4 += 1;
          $endtime = $v['end_time'];
        }
        $newlinenum += 1;
        $gotext = "";
      }
    }
    if (strlen($linetekst) >= 1) {
      if ($newlinenum == 1) {
        $spaces = "";
        for ($i = strlen($linetekst); $i <= 28; $i++) {
          $spaces .= " ";
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        else {
          $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
      }
      else {
        if ($starttid >= 556 && $starttid <= 1159) {
          $tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        else {
          $tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
      }
      if ($starttid >= 556 && $starttid <= 1159) {
        $linenumber1 += 1;
      }
      elseif ($starttid >= 1200 && $starttid <= 1759) {
        $linenumber2 += 1;
      }
      elseif ($starttid >= 1800 && $starttid <= 2259) {
        $linenumber3 += 1;
      }
      else {
        $linenumber4 += 1;
        $endtime = $v['end_time'];
      }
      $newlinenum += 1;
      $gotext = "";
    }
  }

  $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $endtime . "<cyan/>Godnat</line>\n";
  $tekstpage1 .= "</page>\n";
  $tekstpage2 .= "</page>\n";
  $tekstpage3 .= "</page>\n";
  $tekstpage4 .= "</page>\n";

  $output = array();
  $output[1] = $tekstpage1;
  $output[2] = $tekstpage2;
  $output[3] = $tekstpage3;
  $output[4] = $tekstpage4;
  return $output;
}

/*
 * Helper function to build xml - kanal6 specific
 */

function _ttv_teletext_build_kanal6_pages($station, $date, $datetext, $page, $pagetype, $ttvundersider) {
  $channel_tid = 3;
  if ($pagetype == 0) {
    $pagenum1 = $page;
    $pagenum2 = $pagenum1 + 1;
    $pagenum3 = $pagenum2 + 1;
    $pagenum4 = $pagenum3 + 1;
    $pagesub1 = 1;
    $pagesub2 = 1;
    $pagesub3 = 1;
    $pagesub4 = 1;
  }
  else {
    $pagenum1 = $page;
    $pagenum2 = $page;
    $pagenum3 = $page;
    $pagenum4 = $page;
    $pagesub1 = 1;
    $pagesub2 = 2;
    $pagesub3 = 3;
    $pagesub4 = 4;
  }
  if ($station == "Kanal 5") {
    $tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  elseif ($station == "Kanal 4") {
    $tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  elseif ($station == "6eren") {
    if (str_replace("-", "", $date) >= 20090101) {
      $tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
    }
    else {
      $tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
    }
  }
  elseif ($station == "6eren - 2") {
    $tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  else {
    $tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  $linenumber1 = 3;
  $linenumber2 = 3;
  $linenumber3 = 3;
  $linenumber4 = 3;

  $data = _ttv_teletext_get_data($date, $channel_tid, '05:56:00');
  foreach ($data as $k => $v) {
    $starttid = substr($v['start_time'], 0, 5);
    $starttid = str_replace(":", "", $starttid);
    $side = "";
    if ($ttvundersider == 1) {
      if (!empty($v['ttv'])) {
        $side = $v['ttv'];
      }
    }
    $newlinenum = 1;

    $linetekst = "";
    $gotext = "";
    if ($v['hd'] == "yes") {
      $hdtekst = "(HD) ";
    }
    else {
      $hdtekst = "";
    }
    if ($v['local'] == 'yes') {
      $localtekst = "/lok. prg. ";
    }
    else {
      $localtekst = "";
    }
    $extratitle = "";
    if ($v['repeat'] == 'yes' || trim($v['repeat']) == "(G)") {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst)));
      }
    }
    else {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . $localtekst)));
      }
    }
    foreach ($programtitle as $tekst_num => $tekst) {
      if (strlen($tekst) >= 30) {
        # CUT EFTER 29 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
        if (strlen($linetekst) >= 1) {
          $linetekst .= " ";
        }
        $textlen = (27 - strlen($linetekst));
        $linetekst .= substr($tekst, 0, $textlen) . "-";
        $gotext .= ($linetekst);
        $linetekst = substr($tekst, $textlen, strlen($tekst));
      }
      elseif ($tekst == "NEWLINE") {
        $gotext .= ($linetekst);
        $linetekst = "";
      }
      else {
        # HVIS $tekst + $linetekst >= 29 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
        if ((strlen($tekst) + strlen($linetekst)) >= 29) {
          $gotext .= ($linetekst);
          $linetekst = $tekst;
        }
        else {
          if (strlen($linetekst) >= 1) {
            $linetekst .= " ";
          }
          $linetekst .= $tekst;
        }
      }
      if (strlen($gotext) >= 1) {
        if ($newlinenum == 1) {
          $spaces = "";
          for ($i = strlen($gotext); $i <= 28; $i++) {
            $spaces .= " ";
          }
          if ($starttid >= 556 && $starttid <= 1159) {
            $tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          else {
            $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
        }
        else {
          if ($starttid >= 556 && $starttid <= 1159) {
            $tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          else {
            $tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $linenumber1 += 1;
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $linenumber2 += 1;
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $linenumber3 += 1;
        }
        else {
          $linenumber4 += 1;
          $endtime = $v['end_time'];
        }
        $newlinenum += 1;
        $gotext = "";
      }
    }
    if (strlen($linetekst) >= 1) {
      if ($newlinenum == 1) {
        $spaces = "";
        for ($i = strlen($linetekst); $i <= 28; $i++) {
          $spaces .= " ";
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        else {
          $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
      }
      else {
        if ($starttid >= 556 && $starttid <= 1159) {
          $tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        else {
          $tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
      }
      if ($starttid >= 556 && $starttid <= 1159) {
        $linenumber1 += 1;
      }
      elseif ($starttid >= 1200 && $starttid <= 1759) {
        $linenumber2 += 1;
      }
      elseif ($starttid >= 1800 && $starttid <= 2259) {
        $linenumber3 += 1;
      }
      else {
        $linenumber4 += 1;
        $endtime = $v['end_time'];
      }
      $newlinenum += 1;
      $gotext = "";
    }
  }

  $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $endtime . "<cyan/>Godnat</line>\n";
  $tekstpage1 .= "</page>\n";
  $tekstpage2 .= "</page>\n";
  $tekstpage3 .= "</page>\n";
  $tekstpage4 .= "</page>\n";

  $output = array();
  $output[1] = $tekstpage1;
  $output[2] = $tekstpage2;
  $output[3] = $tekstpage3;
  $output[4] = $tekstpage4;
  return $output;
}

function _ttv_teletext_build_xml_305_329($channel_tid, $station, $main_channel, $date, $datetext) {
  $output = array();
  $data = _ttv_teletext_get_data($date, $channel_tid, '05:30:00');
  $teksttvside = 305;
  $teksttvsidemax = 329;

  foreach ($data as $k => $v) {
    if (strlen($v['description']) >= 1 && $teksttvside <= $teksttvsidemax) {
      $topspaces = "";
      for ($i = strlen($datetext); $i <= 20; $i++) {
        $topspaces .= " ";
      }
      $output['pages'][$k]['channel'] = $main_channel;
      $output['pages'][$k]['num'] = $teksttvside;
      $output['pages'][$k]['sub'] = '1';
      $output['pages'][$k]['lang'] = 'S';
      $output['pages'][$k]['line1']['number'] = '4';
      $output['pages'][$k]['line1']['date'] = $datetext . $topspaces . $v['start_time'] . '-' . $v['end_time'];
      //$output .= "<page inserter=\"" . $main_channel . "\" num=\"" . $teksttvside . "\" sub=\"1\" language=\"S\">\n";
      //$output .= "<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . $v['start_time'] . "-" . $v['end_time'] . "</line>\n";
      $linenumber = 3;
      $extratitle = "";
      if ($v['repeat'] == 'yes' || trim($v['repeat']) == "(G)") {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['title'] . $extratitle . " (G)"), $linenumber, $output, 0);
        $output['pages'][$k]['lines'] = $textnew[1];
      }
      else {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['title'] . $extratitle), $linenumber, $output, 0);
        $output['pages'][$k]['lines'] = $textnew[1];
      }
      //$output .= $textnew[1];
      $linenumber = $textnew[2];
      $linenumber += 1;

      $goextraline = 0;
      if (strlen($v['genre']) >= 1) {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['genre']), $linenumber, $output, 1);
        $output['pages'][$k]['lines'] = $textnew[1];
        //$output .= $textnew[1];
        $linenumber = $textnew[2];
        $goextraline = 1;
      }
      if ($v['hd'] == "yes") {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish("(Kan ses i HD)"), $linenumber, $output, 1);
        $output['pages'][$k]['lines'] = $textnew[1];
        //$output .= $textnew[1];
        $linenumber = $textnew[2];
        $goextraline = 1;
      }
      if (strlen($v['original_title']) >= 1) {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['original_title']), $linenumber, $output, 1);
        $output['pages'][$k]['lines'] = $textnew[1];
        //$output .= $textnew[1];
        $linenumber = $textnew[2];
        $goextraline = 1;
      }
      if ($goextraline == 1) {
        $linenumber += 1;
      }
      $extra_rows = 0;
      if (strlen($v['actors']) >= 1) {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['actors']), $extra_rows, $output, 1);
        $output['pages'][$k]['lines'] = $textnew[1];
        $extra_rows = $textnew[2];
      }
      if (strlen($v['instructions']) >= 1) {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['instructions']), $extra_rows, $output, 1);
        $output['pages'][$k]['lines'] = $textnew[1];
        $extra_rows = $textnew[2];
      }

      $line_text = "";
      $description = explode(".", _ttv_teletext_check_danish($v['description']));
      $description_line_num = 0;
      $count = 0;
      foreach ($description as $text_num => $text) {
        $description2 = explode(" ", $text);
        foreach ($description2 as $text_num2 => $text2) {
          if (strlen($text2) >= 40) {
            # CUT EFTER 40 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
            if (strlen($line_text) >= 1) {
              $line_text .= " ";
            }
            $textlen = (37 - strlen($line_text));
            $line_text .= substr($text2, 0, (37 - strlen($line_text))) . "-";
            $description_line_num += 1;
            $line_text = substr($text2, (37 - strlen($line_text)), strlen($text2));
          }
          else {
            # HVIS $text2 + $line_text >= 40 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
            if ((strlen($text2) + strlen($line_text)) >= 39) {
              $description_line_num += 1;
              $line_text = $text2;
            }
            else {
              if (strlen($line_text) >= 1) {
                $line_text .= " ";
              }
              $line_text .= $text2;
            }
          }
        }
        if ($description_line_num <= (20 - $description_line_num - $extra_rows)) {
          $count += 1;
        }
      }

      $line_text = "";
      for ($i = 1; $i <= $count; $i++) {
        $description2 = explode(" ", $description[($i - 1)] . ".");
        foreach ($description2 as $text_num2 => $text) {
          if (strlen($text) >= 1) {
            if ((!(strlen($text) == 1 && stristr($text, ".")))) {
              if (strlen($text) >= 40) {
                # CUT EFTER 40 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
                if (strlen($line_text) >= 1) {
                  if (substr($line_text, -1) == "." && (!(is_numeric(substr(substr($line_text, -2), 0, 1))))) {
                    $line_text .= " ";
                  }
                  elseif (substr($line_text, -1) != ".") {
                    $line_text .= " ";
                  }
                }
                $textlen = (37 - strlen($line_text));
                $line_text .= substr($text, 0, (37 - strlen($line_text))) . "-";
                $output['pages'][$k]['lines'][$linenumber]['color'] = 'white';
                $output['pages'][$k]['lines'][$linenumber]['text'] = ($line_text);
                //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
                $linenumber += 1;
                $line_text = substr($text, (37 - strlen($line_text)), strlen($text));
              }
              else {
                # HVIS $text + $line_text >= 40 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
                if ((strlen($text) + strlen($line_text)) >= 39) {
                  $output['pages'][$k]['lines'][$linenumber]['color'] = 'white';
                  $output['pages'][$k]['lines'][$linenumber]['text'] = ($line_text);
                  //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
                  $linenumber += 1;
                  $line_text = $text;
                }
                else {
                  if (strlen($line_text) >= 1) {
                    if (substr($line_text, -1) == "." && (!(is_numeric(substr(substr($line_text, -2), 0, 1))))) {
                      $line_text .= " ";
                    }
                    elseif (substr($line_text, -1) != ".") {
                      $line_text .= " ";
                    }
                  }
                  $line_text .= $text;
                }
              }
            }
          }
        }
      }
      $output['pages'][$k]['lines'][$linenumber]['color'] = 'white';
      $output['pages'][$k]['lines'][$linenumber]['text'] = ($line_text);
      //$output .= "<line num=\"" . $linenumber . "\"><white/>" . ($line_text) . "</line>\n";
      $linenumber++;

      if (strlen($v['actors']) >= 1) {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['actors']), $linenumber, $output, 1);
        $output['pages'][$k]['lines'] = $textnew[1];
        //$output .= $textnew[1];
        $extra_rows = $textnew[2];
      }
      if (strlen($v['instructions']) >= 1) {
        $textnew = _ttv_teletext_cuttext(_ttv_teletext_check_danish($v['instructions']), $linenumber, $output, 1);
        $output['pages'][$k]['lines'] = $textnew[1];
        //$output .= $textnew[1];
        $extra_rows = $textnew[2];
      }
      $side = $teksttvside;
      //$output .= "</page>\n";
      $teksttvside += 1;
    }
    else {
      $side = "";
    }
  }
  for ($i = $teksttvside; $i <= $teksttvsidemax; $i++) {
    $output['pages'][$i]['channel'] = $main_channel;
    $output['pages'][$k]['num'] = $teksttvside;
    $output['pages'][$k]['sub'] = '1';
    $output['pages'][$k]['lang'] = 'S';
    $output['pages'][$k]['line1']['number'] = '4';
    $output['pages'][$k]['line1']['date'] = $datetext;
    //$output .= "<page inserter=\".$main_channel.\" num=\"" . $i . "\" sub=\"1\" language=\"S\">\n";
    //$output .= "<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    //$output .= "</page>\n";
  }
  /* $xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\" ?>\n<teletext user=\"propeople\" pass=\"tvdanmark\">\n"; */
  //$xml .= $output;
  return $output;
}

/*
 * Helper function to build xml - kanal4 specific
 */

function _ttv_teletext_build_kanal4_pages_template($station, $date, $datetext, $page, $pagetype, $ttvundersider) {
  $output = array();
  $channel_tid = 1;
  if ($pagetype == 0) {
    $pagenum1 = $page;
    $pagenum2 = $pagenum1 + 1;
    $pagenum3 = $pagenum2 + 1;
    $pagenum4 = $pagenum3 + 1;
    $pagesub1 = 1;
    $pagesub2 = 1;
    $pagesub3 = 1;
    $pagesub4 = 1;
  }
  else {
    $pagenum1 = $page;
    $pagenum2 = $page;
    $pagenum3 = $page;
    $pagenum4 = $page;
    $pagesub1 = 1;
    $pagesub2 = 2;
    $pagesub3 = 3;
    $pagesub4 = 4;
  }
  if ($station == "Kanal 5") {
    $output['pages'][1]['channel'] = 'KANAL4';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '5';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'red';
    $output['pages'][1]['line1']['color2'] = 'blue';
    //$tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'KANAL4';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '5';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'red';
    $output['pages'][2]['line1']['color2'] = 'blue';
    //$tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'KANAL4';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '5';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'red';
    $output['pages'][3]['line1']['color2'] = 'blue';
    //$tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'KANAL4';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '5';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'red';
    $output['pages'][4]['line1']['color2'] = 'blue';
    //$tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  elseif ($station == "6eren") {
    if (date("Ymd") >= 20090101) {
      $output['pages'][1]['channel'] = 'KANAL4';
      $output['pages'][1]['num'] = $pagenum1;
      $output['pages'][1]['sub'] = $pagesub1;
      $output['pages'][1]['lang'] = 'S';
      $output['pages'][1]['line1']['number'] = '6';
      $output['pages'][1]['line1']['date'] = $datetext;
      $output['pages'][1]['line1']['color1'] = 'blue';
      $output['pages'][1]['line1']['color2'] = 'black';
      //$tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][2]['channel'] = 'KANAL4';
      $output['pages'][2]['num'] = $pagenum2;
      $output['pages'][2]['sub'] = $pagesub2;
      $output['pages'][2]['lang'] = 'S';
      $output['pages'][2]['line1']['number'] = '6';
      $output['pages'][2]['line1']['date'] = $datetext;
      $output['pages'][2]['line1']['color1'] = 'blue';
      $output['pages'][2]['line1']['color2'] = 'black';
      //$tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][3]['channel'] = 'KANAL4';
      $output['pages'][3]['num'] = $pagenum3;
      $output['pages'][3]['sub'] = $pagesub3;
      $output['pages'][3]['lang'] = 'S';
      $output['pages'][3]['line1']['number'] = '6';
      $output['pages'][3]['line1']['date'] = $datetext;
      $output['pages'][3]['line1']['color1'] = 'blue';
      $output['pages'][3]['line1']['color2'] = 'black';
      //$tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][4]['channel'] = 'KANAL4';
      $output['pages'][4]['num'] = $pagenum4;
      $output['pages'][4]['sub'] = $pagesub4;
      $output['pages'][4]['lang'] = 'S';
      $output['pages'][4]['line1']['number'] = '6';
      $output['pages'][4]['line1']['date'] = $datetext;
      $output['pages'][4]['line1']['color1'] = 'blue';
      $output['pages'][4]['line1']['color2'] = 'black';
      //$tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
    }
    else {
      $output['pages'][1]['channel'] = 'KANAL4';
      $output['pages'][1]['num'] = $pagenum1;
      $output['pages'][1]['sub'] = $pagesub1;
      $output['pages'][1]['lang'] = 'S';
      $output['pages'][1]['line1']['number'] = 'N';
      $output['pages'][1]['line1']['date'] = $datetext;
      $output['pages'][1]['line1']['color1'] = 'blue';
      $output['pages'][1]['line1']['color2'] = 'black';
      //$tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][2]['channel'] = 'KANAL4';
      $output['pages'][2]['num'] = $pagenum2;
      $output['pages'][2]['sub'] = $pagesub2;
      $output['pages'][2]['lang'] = 'S';
      $output['pages'][2]['line1']['number'] = 'N';
      $output['pages'][2]['line1']['date'] = $datetext;
      $output['pages'][2]['line1']['color1'] = 'blue';
      $output['pages'][2]['line1']['color2'] = 'black';
      //$tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][3]['channel'] = 'KANAL4';
      $output['pages'][3]['num'] = $pagenum3;
      $output['pages'][3]['sub'] = $pagesub3;
      $output['pages'][3]['lang'] = 'S';
      $output['pages'][3]['line1']['number'] = 'N';
      $output['pages'][3]['line1']['date'] = $datetext;
      $output['pages'][3]['line1']['color1'] = 'blue';
      $output['pages'][3]['line1']['color2'] = 'black';
      //$tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][4]['channel'] = 'KANAL4';
      $output['pages'][4]['num'] = $pagenum4;
      $output['pages'][4]['sub'] = $pagesub4;
      $output['pages'][4]['lang'] = 'S';
      $output['pages'][4]['line1']['number'] = 'N';
      $output['pages'][4]['line1']['date'] = $datetext;
      $output['pages'][4]['line1']['color1'] = 'blue';
      $output['pages'][4]['line1']['color2'] = 'black';
      //$tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
    }
  }
  elseif ($station == "Kanal 4 Østjylland") {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 23; $i++) {
      $topspaces .= " ";
    }
    $output['pages'][1]['channel'] = 'KANAL4';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext . $topspaces . 'Østjyll.';
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
    $output['pages'][2]['channel'] = 'KANAL4';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext . $topspaces . 'Østjyll.';
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
    $output['pages'][3]['channel'] = 'KANAL4';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext . $topspaces . 'Østjyll.';
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
    $output['pages'][4]['channel'] = 'KANAL4';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext . $topspaces . 'Østjyll.';
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "ï¿½stjyll.</line>\n";
  }
  elseif ($station == "Kanal 4 Aalborg") {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 24; $i++) {
      $topspaces .= " ";
    }
    $output['pages'][1]['channel'] = 'KANAL4';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext . $topspaces . 'Aalborg';
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
    $output['pages'][2]['channel'] = 'KANAL4';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext . $topspaces . 'Aalborg';
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
    $output['pages'][3]['channel'] = 'KANAL4';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext . $topspaces . 'Aalborg';
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
    $output['pages'][4]['channel'] = 'KANAL4';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext . $topspaces . 'Aalborg';
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Aalborg</line>\n";
  }
  elseif ($station == "Kanal 4 Fyn") {
    $topspaces = "";
    for ($i = strlen($datetext); $i <= 28; $i++) {
      $topspaces .= " ";
    }
    $output['pages'][1]['channel'] = 'KANAL4';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext . $topspaces . 'Fyn';
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
    $output['pages'][2]['channel'] = 'KANAL4';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext . $topspaces . 'Fyn';
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
    $output['pages'][3]['channel'] = 'KANAL4';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext . $topspaces . 'Fyn';
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
    $output['pages'][4]['channel'] = 'KANAL4';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext . $topspaces . 'Fyn';
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . $topspaces . "Fyn</line>\n";
  }
  else {
    $output['pages'][1]['channel'] = 'KANAL4';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"KANAL4\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'KANAL4';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"KANAL4\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'KANAL4';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"KANAL4\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'KANAL4';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"KANAL4\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  $linenumber1 = 3;
  $linenumber2 = 3;
  $linenumber3 = 3;
  $linenumber4 = 3;

  $data = _ttv_teletext_get_data($date, $channel_tid, '05:56:00');
  foreach ($data as $k => $v) {
    $starttid = substr($v['start_time'], 0, 5);
    $starttid = str_replace(":", "", $starttid);
    $side = "";
    if ($ttvundersider == 1) {
      if (!empty($v['ttv'])) {
        $side = $v['ttv'];
      }
    }
    $newlinenum = 1;

    $linetekst = "";
    $gotext = "";
    if ($v['hd'] == "yes") {
      $hdtekst = "(HD) ";
    }
    else {
      $hdtekst = "";
    }
    if ($v['local'] == 'yes') {
      $localtekst = "/lok. prg. ";
    }
    else {
      $localtekst = "";
    }
    $extratitle = "";
    if ($v['repeat'] == 'yes' || trim($v['repeat']) == "(G)") {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst)));
      }
    }
    else {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . $localtekst)));
      }
    }
    foreach ($programtitle as $tekst_num => $tekst) {
      if (strlen($tekst) >= 30) {
        # CUT EFTER 29 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
        if (strlen($linetekst) >= 1) {
          $linetekst .= " ";
        }
        $textlen = (27 - strlen($linetekst));
        $linetekst .= substr($tekst, 0, $textlen) . "-";
        $gotext .= ($linetekst);
        $linetekst = substr($tekst, $textlen, strlen($tekst));
      }
      elseif ($tekst == "NEWLINE") {
        $gotext .= ($linetekst);
        $linetekst = "";
      }
      else {
        # HVIS $tekst + $linetekst >= 29 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
        if ((strlen($tekst) + strlen($linetekst)) >= 29) {
          $gotext .= ($linetekst);
          $linetekst = $tekst;
        }
        else {
          if (strlen($linetekst) >= 1) {
            $linetekst .= " ";
          }
          $linetekst .= $tekst;
        }
      }
      if (strlen($gotext) >= 1) {
        if ($newlinenum == 1) {
          $spaces = "";
          for ($i = strlen($gotext); $i <= 28; $i++) {
            $spaces .= " ";
          }
          if ($starttid >= 556 && $starttid <= 1159) {
            //[line3+]->[num], [starttime], [title], [description]
            $output['pages'][1]['lines'][$linenumber1]['start_time'] = $v['start_time'];
            $output['pages'][1]['lines'][$linenumber1]['title'] = $gotext;
            $output['pages'][1]['lines'][$linenumber1]['description'] = $spaces . $side;
            //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $output['pages'][2]['lines'][$linenumber2]['start_time'] = $v['start_time'];
            $output['pages'][2]['lines'][$linenumber2]['title'] = $gotext;
            $output['pages'][2]['lines'][$linenumber2]['description'] = $spaces . $side;
            //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $output['pages'][3]['lines'][$linenumber3]['start_time'] = $v['start_time'];
            $output['pages'][3]['lines'][$linenumber3]['title'] = $gotext;
            $output['pages'][3]['lines'][$linenumber3]['description'] = $spaces . $side;
            //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          else {
            $output['pages'][4]['lines'][$linenumber4]['start_time'] = $v['start_time'];
            $output['pages'][4]['lines'][$linenumber4]['title'] = $gotext;
            $output['pages'][4]['lines'][$linenumber4]['description'] = $spaces . $side;
            //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
        }
        else {
          if ($starttid >= 556 && $starttid <= 1159) {
            $output['pages'][1]['lines'][$linenumber1]['start_time'] = '';
            $output['pages'][1]['lines'][$linenumber1]['title'] = $gotext;
            $output['pages'][1]['lines'][$linenumber1]['description'] = '';
            //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $output['pages'][2]['lines'][$linenumber2]['start_time'] = '';
            $output['pages'][2]['lines'][$linenumber2]['title'] = $gotext;
            $output['pages'][2]['lines'][$linenumber2]['description'] = '';
            //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $output['pages'][3]['lines'][$linenumber3]['start_time'] = '';
            $output['pages'][3]['lines'][$linenumber3]['title'] = $gotext;
            $output['pages'][3]['lines'][$linenumber3]['description'] = '';
            //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          else {
            $output['pages'][4]['lines'][$linenumber4]['start_time'] = '';
            $output['pages'][4]['lines'][$linenumber4]['title'] = $gotext;
            $output['pages'][4]['lines'][$linenumber4]['description'] = '';
            //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $linenumber1 += 1;
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $linenumber2 += 1;
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $linenumber3 += 1;
        }
        else {
          $linenumber4 += 1;
          $endtime = $v['end_time'];
        }
        $newlinenum += 1;
        $gotext = "";
      }
    }
    if (strlen($linetekst) >= 1) {
      if ($newlinenum == 1) {
        $spaces = "";
        for ($i = strlen($linetekst); $i <= 28; $i++) {
          $spaces .= " ";
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $output['pages'][1]['lines'][$linenumber1]['start_time'] = $v['start_time'];
          $output['pages'][1]['lines'][$linenumber1]['title'] = $linetekst;
          $output['pages'][1]['lines'][$linenumber1]['description'] = $spaces . $side;
          //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $output['pages'][2]['lines'][$linenumber2]['start_time'] = $v['start_time'];
          $output['pages'][2]['lines'][$linenumber2]['title'] = $linetekst;
          $output['pages'][2]['lines'][$linenumber2]['description'] = $spaces . $side;
          //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $output['pages'][3]['lines'][$linenumber3]['start_time'] = $v['start_time'];
          $output['pages'][3]['lines'][$linenumber3]['title'] = $linetekst;
          $output['pages'][3]['lines'][$linenumber3]['description'] = $spaces . $side;
          //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        else {
          $output['pages'][4]['lines'][$linenumber4]['start_time'] = $v['start_time'];
          $output['pages'][4]['lines'][$linenumber4]['title'] = $linetekst;
          $output['pages'][4]['lines'][$linenumber4]['description'] = $spaces . $side;
          //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
      }
      else {
        if ($starttid >= 556 && $starttid <= 1159) {
          $output['pages'][1]['lines'][$linenumber1]['title'] = $linetekst;
          $output['pages'][1]['lines'][$linenumber1]['start_time'] = '';
          $output['pages'][1]['lines'][$linenumber1]['description'] = '';
          //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $output['pages'][2]['lines'][$linenumber2]['title'] = $linetekst;
          $output['pages'][2]['lines'][$linenumber2]['start_time'] = '';
          $output['pages'][2]['lines'][$linenumber2]['description'] = '';
          //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $output['pages'][3]['lines'][$linenumber3]['title'] = $linetekst;
          $output['pages'][3]['lines'][$linenumber3]['start_time'] = '';
          $output['pages'][3]['lines'][$linenumber3]['description'] = '';
          //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        else {
          $output['pages'][4]['lines'][$linenumber4]['title'] = $linetekst;
          $output['pages'][4]['lines'][$linenumber4]['start_time'] = '';
          $output['pages'][4]['lines'][$linenumber4]['description'] = '';
          //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
      }
      if ($starttid >= 556 && $starttid <= 1159) {
        $linenumber1 += 1;
      }
      elseif ($starttid >= 1200 && $starttid <= 1759) {
        $linenumber2 += 1;
      }
      elseif ($starttid >= 1800 && $starttid <= 2259) {
        $linenumber3 += 1;
      }
      else {
        $linenumber4 += 1;
        $endtime = $v['end_time'];
      }
      $newlinenum += 1;
      $gotext = "";
    }
  }

  $output['pages'][4]['lines'][$linenumber4]['start_time'] = $endtime;
  $output['pages'][4]['lines'][$linenumber4]['title'] = 'Godnat';
  $output['pages'][4]['lines'][$linenumber4]['description'] = '';
  //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $endtime . "<cyan/>Godnat</line>\n";
  /* $tekstpage1 .= "</page>\n";
    $tekstpage2 .= "</page>\n";
    $tekstpage3 .= "</page>\n";
    $tekstpage4 .= "</page>\n";

    $output = array();
    $output[1] = $tekstpage1;
    $output[2] = $tekstpage2;
    $output[3] = $tekstpage3;
    $output[4] = $tekstpage4; */
  return $output;
}

/*
 * Helper function to build xml - kanal5 specific
 */

function _ttv_teletext_build_kanal5_pages_template($station, $date, $datetext, $page, $pagetype, $ttvundersider) {
  $channel_tid = 2;
  if ($pagetype == 0) {
    $pagenum1 = $page;
    $pagenum2 = $pagenum1 + 1;
    $pagenum3 = $pagenum2 + 1;
    $pagenum4 = $pagenum3 + 1;
    $pagesub1 = 1;
    $pagesub2 = 1;
    $pagesub3 = 1;
    $pagesub4 = 1;
  }
  else {
    $pagenum1 = $page;
    $pagenum2 = $page;
    $pagenum3 = $page;
    $pagenum4 = $page;
    $pagesub1 = 1;
    $pagesub2 = 2;
    $pagesub3 = 3;
    $pagesub4 = 4;
  }
  if ($station == "Kanal 5") {
    $output['pages'][1]['channel'] = 'KANAL5';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '5';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'red';
    $output['pages'][1]['line1']['color2'] = 'blue';
    //$tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'KANAL5';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '5';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'red';
    $output['pages'][2]['line1']['color2'] = 'blue';
    //$tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'KANAL5';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '5';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'red';
    $output['pages'][3]['line1']['color2'] = 'blue';
    //$tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'KANAL5';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '5';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'red';
    $output['pages'][4]['line1']['color2'] = 'blue';
    //$tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  elseif ($station == "Kanal 4") {
    $output['pages'][1]['channel'] = 'KANAL5';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'KANAL5';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'KANAL5';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'KANAL5';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  elseif ($station == "6eren") {
    if (date("Ymd") >= 20090101) {
      $output['pages'][1]['channel'] = 'KANAL5';
      $output['pages'][1]['num'] = $pagenum1;
      $output['pages'][1]['sub'] = $pagesub1;
      $output['pages'][1]['lang'] = 'S';
      $output['pages'][1]['line1']['number'] = '6';
      $output['pages'][1]['line1']['date'] = $datetext;
      $output['pages'][1]['line1']['color1'] = 'blue';
      $output['pages'][1]['line1']['color2'] = 'black';
      //$tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][2]['channel'] = 'KANAL5';
      $output['pages'][2]['num'] = $pagenum2;
      $output['pages'][2]['sub'] = $pagesub2;
      $output['pages'][2]['lang'] = 'S';
      $output['pages'][2]['line1']['number'] = '6';
      $output['pages'][2]['line1']['date'] = $datetext;
      $output['pages'][2]['line1']['color1'] = 'blue';
      $output['pages'][2]['line1']['color2'] = 'black';
      //$tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][3]['channel'] = 'KANAL5';
      $output['pages'][3]['num'] = $pagenum3;
      $output['pages'][3]['sub'] = $pagesub3;
      $output['pages'][3]['lang'] = 'S';
      $output['pages'][3]['line1']['number'] = '6';
      $output['pages'][3]['line1']['date'] = $datetext;
      $output['pages'][3]['line1']['color1'] = 'blue';
      $output['pages'][3]['line1']['color2'] = 'black';
      //$tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][4]['channel'] = 'KANAL5';
      $output['pages'][4]['num'] = $pagenum4;
      $output['pages'][4]['sub'] = $pagesub4;
      $output['pages'][4]['lang'] = 'S';
      $output['pages'][4]['line1']['number'] = '6';
      $output['pages'][4]['line1']['date'] = $datetext;
      $output['pages'][4]['line1']['color1'] = 'blue';
      $output['pages'][4]['line1']['color2'] = 'black';
      //$tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
    }
    else {
      $output['pages'][1]['channel'] = 'KANAL5';
      $output['pages'][1]['num'] = $pagenum1;
      $output['pages'][1]['sub'] = $pagesub1;
      $output['pages'][1]['lang'] = 'S';
      $output['pages'][1]['line1']['number'] = 'N';
      $output['pages'][1]['line1']['date'] = $datetext;
      $output['pages'][1]['line1']['color1'] = 'blue';
      $output['pages'][1]['line1']['color2'] = 'black';
      //$tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][2]['channel'] = 'KANAL5';
      $output['pages'][2]['num'] = $pagenum2;
      $output['pages'][2]['sub'] = $pagesub2;
      $output['pages'][2]['lang'] = 'S';
      $output['pages'][2]['line1']['number'] = 'N';
      $output['pages'][2]['line1']['date'] = $datetext;
      $output['pages'][2]['line1']['color1'] = 'blue';
      $output['pages'][2]['line1']['color2'] = 'black';
      //$tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][3]['channel'] = 'KANAL5';
      $output['pages'][3]['num'] = $pagenum3;
      $output['pages'][3]['sub'] = $pagesub3;
      $output['pages'][3]['lang'] = 'S';
      $output['pages'][3]['line1']['number'] = 'N';
      $output['pages'][3]['line1']['date'] = $datetext;
      $output['pages'][3]['line1']['color1'] = 'blue';
      $output['pages'][3]['line1']['color2'] = 'black';
      //$tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][4]['channel'] = 'KANAL5';
      $output['pages'][4]['num'] = $pagenum4;
      $output['pages'][4]['sub'] = $pagesub4;
      $output['pages'][4]['lang'] = 'S';
      $output['pages'][4]['line1']['number'] = 'N';
      $output['pages'][4]['line1']['date'] = $datetext;
      $output['pages'][4]['line1']['color1'] = 'blue';
      $output['pages'][4]['line1']['color2'] = 'black';
      //$tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
    }
  }
  else {
    $output['pages'][1]['channel'] = 'KANAL5';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'KANAL5';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'KANAL5';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'KANAL5';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  $linenumber1 = 3;
  $linenumber2 = 3;
  $linenumber3 = 3;
  $linenumber4 = 3;

  $data = _ttv_teletext_get_data($date, $channel_tid, '05:56:00');
  foreach ($data as $k => $v) {
    $starttid = substr($v['start_time'], 0, 5);
    $starttid = str_replace(":", "", $starttid);
    $side = "";
    if ($ttvundersider == 1) {
      if (!empty($v['ttv'])) {
        $side = $v['ttv'];
      }
    }
    $newlinenum = 1;

    $linetekst = "";
    $gotext = "";
    if ($v['hd'] == "yes") {
      $hdtekst = "(HD) ";
    }
    else {
      $hdtekst = "";
    }
    if ($v['local'] == 'yes') {
      $localtekst = "/lok. prg. ";
    }
    else {
      $localtekst = "";
    }
    $extratitle = "";
    if ($v['repeat'] == 'yes' || trim($v['repeat']) == "(G)") {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst)));
      }
    }
    else {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . $localtekst)));
      }
    }
    foreach ($programtitle as $tekst_num => $tekst) {
      if (strlen($tekst) >= 30) {
        # CUT EFTER 29 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
        if (strlen($linetekst) >= 1) {
          $linetekst .= " ";
        }
        $textlen = (27 - strlen($linetekst));
        $linetekst .= substr($tekst, 0, $textlen) . "-";
        $gotext .= ($linetekst);
        $linetekst = substr($tekst, $textlen, strlen($tekst));
      }
      elseif ($tekst == "NEWLINE") {
        $gotext .= ($linetekst);
        $linetekst = "";
      }
      else {
        # HVIS $tekst + $linetekst >= 29 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
        if ((strlen($tekst) + strlen($linetekst)) >= 29) {
          $gotext .= ($linetekst);
          $linetekst = $tekst;
        }
        else {
          if (strlen($linetekst) >= 1) {
            $linetekst .= " ";
          }
          $linetekst .= $tekst;
        }
      }
      if (strlen($gotext) >= 1) {
        if ($newlinenum == 1) {
          $spaces = "";
          for ($i = strlen($gotext); $i <= 28; $i++) {
            $spaces .= " ";
          }
          if ($starttid >= 556 && $starttid <= 1159) {
            $output['pages'][1]['lines'][$linenumber1]['start_time'] = $v['start_time'];
            $output['pages'][1]['lines'][$linenumber1]['title'] = $gotext;
            $output['pages'][1]['lines'][$linenumber1]['description'] = $spaces . $side;
            //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $output['pages'][2]['lines'][$linenumber2]['start_time'] = $v['start_time'];
            $output['pages'][2]['lines'][$linenumber2]['title'] = $gotext;
            $output['pages'][2]['lines'][$linenumber2]['description'] = $spaces . $side;
            //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $output['pages'][3]['lines'][$linenumber3]['start_time'] = $v['start_time'];
            $output['pages'][3]['lines'][$linenumber3]['title'] = $gotext;
            $output['pages'][3]['lines'][$linenumber3]['description'] = $spaces . $side;
            //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          else {
            $output['pages'][4]['lines'][$linenumber4]['start_time'] = $v['start_time'];
            $output['pages'][4]['lines'][$linenumber4]['title'] = $gotext;
            $output['pages'][4]['lines'][$linenumber4]['description'] = $spaces . $side;
            //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
        }
        else {
          if ($starttid >= 556 && $starttid <= 1159) {
            $output['pages'][1]['lines'][$linenumber1]['start_time'] = '';
            $output['pages'][1]['lines'][$linenumber1]['title'] = $gotext;
            $output['pages'][1]['lines'][$linenumber1]['description'] = '';
            //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $output['pages'][2]['lines'][$linenumber2]['start_time'] = '';
            $output['pages'][2]['lines'][$linenumber2]['title'] = $gotext;
            $output['pages'][2]['lines'][$linenumber2]['description'] = '';
            //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $output['pages'][3]['lines'][$linenumber3]['start_time'] = '';
            $output['pages'][3]['lines'][$linenumber3]['title'] = $gotext;
            $output['pages'][3]['lines'][$linenumber3]['description'] = '';
            //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          else {
            $output['pages'][4]['lines'][$linenumber4]['start_time'] = '';
            $output['pages'][4]['lines'][$linenumber4]['title'] = $gotext;
            $output['pages'][4]['lines'][$linenumber4]['description'] = '';
            //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $linenumber1 += 1;
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $linenumber2 += 1;
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $linenumber3 += 1;
        }
        else {
          $linenumber4 += 1;
          $endtime = $v['end_time'];
        }
        $newlinenum += 1;
        $gotext = "";
      }
    }
    if (strlen($linetekst) >= 1) {
      if ($newlinenum == 1) {
        $spaces = "";
        for ($i = strlen($linetekst); $i <= 28; $i++) {
          $spaces .= " ";
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $output['pages'][1]['lines'][$linenumber1]['start_time'] = $v['start_time'];
          $output['pages'][1]['lines'][$linenumber1]['title'] = $linetekst;
          $output['pages'][1]['lines'][$linenumber1]['description'] = $spaces . $side;
          //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $output['pages'][2]['lines'][$linenumber2]['start_time'] = $v['start_time'];
          $output['pages'][2]['lines'][$linenumber2]['title'] = $linetekst;
          $output['pages'][2]['lines'][$linenumber2]['description'] = $spaces . $side;
          //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $output['pages'][3]['lines'][$linenumber3]['start_time'] = $v['start_time'];
          $output['pages'][3]['lines'][$linenumber3]['title'] = $linetekst;
          $output['pages'][3]['lines'][$linenumber3]['description'] = $spaces . $side;
          //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        else {
          $output['pages'][4]['lines'][$linenumber4]['start_time'] = $v['start_time'];
          $output['pages'][4]['lines'][$linenumber4]['title'] = $linetekst;
          $output['pages'][4]['lines'][$linenumber4]['description'] = $spaces . $side;
          //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
      }
      else {
        if ($starttid >= 556 && $starttid <= 1159) {
          $output['pages'][1]['lines'][$linenumber1]['title'] = $linetekst;
          $output['pages'][1]['lines'][$linenumber1]['start_time'] = '';
          $output['pages'][1]['lines'][$linenumber1]['description'] = '';
          //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $output['pages'][2]['lines'][$linenumber2]['title'] = $linetekst;
          $output['pages'][2]['lines'][$linenumber2]['start_time'] = '';
          $output['pages'][2]['lines'][$linenumber2]['description'] = '';
          //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $output['pages'][3]['lines'][$linenumber3]['title'] = $linetekst;
          $output['pages'][3]['lines'][$linenumber3]['start_time'] = '';
          $output['pages'][3]['lines'][$linenumber3]['description'] = '';
          //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        else {
          $output['pages'][4]['lines'][$linenumber4]['title'] = $linetekst;
          $output['pages'][4]['lines'][$linenumber4]['start_time'] = '';
          $output['pages'][4]['lines'][$linenumber4]['description'] = '';
          //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
      }
      if ($starttid >= 556 && $starttid <= 1159) {
        $linenumber1 += 1;
      }
      elseif ($starttid >= 1200 && $starttid <= 1759) {
        $linenumber2 += 1;
      }
      elseif ($starttid >= 1800 && $starttid <= 2259) {
        $linenumber3 += 1;
      }
      else {
        $linenumber4 += 1;
        $endtime = $v['end_time'];
      }
      $newlinenum += 1;
      $gotext = "";
    }
  }

  $output['pages'][4]['lines'][$linenumber4]['start_time'] = $endtime;
  $output['pages'][4]['lines'][$linenumber4]['title'] = 'Godnat';
  $output['pages'][4]['lines'][$linenumber4]['description'] = '';
  /* $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $endtime . "<cyan/>Godnat</line>\n";
    $tekstpage1 .= "</page>\n";
    $tekstpage2 .= "</page>\n";
    $tekstpage3 .= "</page>\n";
    $tekstpage4 .= "</page>\n";

    $output = array();
    $output[1] = $tekstpage1;
    $output[2] = $tekstpage2;
    $output[3] = $tekstpage3;
    $output[4] = $tekstpage4; */
  return $output;
}

/*
 * Helper function to build xml - kanal6 specific
 */

function _ttv_teletext_build_kanal6_pages_template($station, $date, $datetext, $page, $pagetype, $ttvundersider) {
  $channel_tid = 3;
  if ($pagetype == 0) {
    $pagenum1 = $page;
    $pagenum2 = $pagenum1 + 1;
    $pagenum3 = $pagenum2 + 1;
    $pagenum4 = $pagenum3 + 1;
    $pagesub1 = 1;
    $pagesub2 = 1;
    $pagesub3 = 1;
    $pagesub4 = 1;
  }
  else {
    $pagenum1 = $page;
    $pagenum2 = $page;
    $pagenum3 = $page;
    $pagenum4 = $page;
    $pagesub1 = 1;
    $pagesub2 = 2;
    $pagesub3 = 3;
    $pagesub4 = 4;
  }
  if ($station == "Kanal 5") {
    $output['pages'][1]['channel'] = 'SBSNET';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '5';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'red';
    $output['pages'][1]['line1']['color2'] = 'blue';
    //$tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'SBSNET';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '5';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'red';
    $output['pages'][2]['line1']['color2'] = 'blue';
    //$tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'SBSNET';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '5';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'red';
    $output['pages'][3]['line1']['color2'] = 'blue';
    //$tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'SBSNET';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '5';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'red';
    $output['pages'][4]['line1']['color2'] = 'blue';
    //$tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><red/><background/><white/>5 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  elseif ($station == "Kanal 4") {
    $output['pages'][1]['channel'] = 'SBSNET';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"KANAL5\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'SBSNET';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"KANAL5\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'SBSNET';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"KANAL5\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'SBSNET';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  elseif ($station == "6eren") {
    if (str_replace("-", "", $date) >= 20090101) {
      $output['pages'][1]['channel'] = 'SBSNET';
      $output['pages'][1]['num'] = $pagenum1;
      $output['pages'][1]['sub'] = $pagesub1;
      $output['pages'][1]['lang'] = 'S';
      $output['pages'][1]['line1']['number'] = '6';
      $output['pages'][1]['line1']['date'] = $datetext;
      $output['pages'][1]['line1']['color1'] = 'blue';
      $output['pages'][1]['line1']['color2'] = 'black';
      //$tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][2]['channel'] = 'SBSNET';
      $output['pages'][2]['num'] = $pagenum2;
      $output['pages'][2]['sub'] = $pagesub2;
      $output['pages'][2]['lang'] = 'S';
      $output['pages'][2]['line1']['number'] = '6';
      $output['pages'][2]['line1']['date'] = $datetext;
      $output['pages'][2]['line1']['color1'] = 'blue';
      $output['pages'][2]['line1']['color2'] = 'black';
      //$tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][3]['channel'] = 'SBSNET';
      $output['pages'][3]['num'] = $pagenum3;
      $output['pages'][3]['sub'] = $pagesub3;
      $output['pages'][3]['lang'] = 'S';
      $output['pages'][3]['line1']['number'] = '6';
      $output['pages'][3]['line1']['date'] = $datetext;
      $output['pages'][3]['line1']['color1'] = 'blue';
      $output['pages'][3]['line1']['color2'] = 'black';
      //$tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][4]['channel'] = 'SBSNET';
      $output['pages'][4]['num'] = $pagenum4;
      $output['pages'][4]['sub'] = $pagesub4;
      $output['pages'][4]['lang'] = 'S';
      $output['pages'][4]['line1']['number'] = '6';
      $output['pages'][4]['line1']['date'] = $datetext;
      $output['pages'][4]['line1']['color1'] = 'blue';
      $output['pages'][4]['line1']['color2'] = 'black';
      //$tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><black/>" . $datetext . "</line>\n";
    }
    else {
      $output['pages'][1]['channel'] = 'SBSNET';
      $output['pages'][1]['num'] = $pagenum1;
      $output['pages'][1]['sub'] = $pagesub1;
      $output['pages'][1]['lang'] = 'S';
      $output['pages'][1]['line1']['number'] = 'N';
      $output['pages'][1]['line1']['date'] = $datetext;
      $output['pages'][1]['line1']['color1'] = 'blue';
      $output['pages'][1]['line1']['color2'] = 'black';
      //$tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][2]['channel'] = 'SBSNET';
      $output['pages'][2]['num'] = $pagenum2;
      $output['pages'][2]['sub'] = $pagesub2;
      $output['pages'][2]['lang'] = 'S';
      $output['pages'][2]['line1']['number'] = 'N';
      $output['pages'][2]['line1']['date'] = $datetext;
      $output['pages'][2]['line1']['color1'] = 'blue';
      $output['pages'][2]['line1']['color2'] = 'black';
      //$tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][3]['channel'] = 'SBSNET';
      $output['pages'][3]['num'] = $pagenum3;
      $output['pages'][3]['sub'] = $pagesub3;
      $output['pages'][3]['lang'] = 'S';
      $output['pages'][3]['line1']['number'] = 'N';
      $output['pages'][3]['line1']['date'] = $datetext;
      $output['pages'][3]['line1']['color1'] = 'blue';
      $output['pages'][3]['line1']['color2'] = 'black';
      //$tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
      $output['pages'][4]['channel'] = 'SBSNET';
      $output['pages'][4]['num'] = $pagenum4;
      $output['pages'][4]['sub'] = $pagesub4;
      $output['pages'][4]['lang'] = 'S';
      $output['pages'][4]['line1']['number'] = 'N';
      $output['pages'][4]['line1']['date'] = $datetext;
      $output['pages'][4]['line1']['color1'] = 'blue';
      $output['pages'][4]['line1']['color2'] = 'black';
      //$tekstpage4 = "<page inserter=\"KANAL5\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>N <white/><background/><black/>" . $datetext . "</line>\n";
    }
  }
  elseif ($station == "6eren - 2") {
    $output['pages'][1]['channel'] = 'SBSNET';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '6';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'blue';
    $output['pages'][1]['line1']['color2'] = 'blue';
    //$tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'SBSNET';
    $output['pages'][2]['num'] = $pagenum2;
    $output['pages'][2]['sub'] = $pagesub2;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '6';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'blue';
    $output['pages'][2]['line1']['color2'] = 'blue';
    //$tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'SBSNET';
    $output['pages'][3]['num'] = $pagenum3;
    $output['pages'][3]['sub'] = $pagesub3;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '6';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'blue';
    $output['pages'][3]['line1']['color2'] = 'blue';
    //$tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'SBSNET';
    $output['pages'][4]['num'] = $pagenum4;
    $output['pages'][4]['sub'] = $pagesub4;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '6';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'blue';
    $output['pages'][4]['line1']['color2'] = 'blue';
    //$tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><blue/><background/><white/>6 <white/><background/><blue/>" . $datetext . "</line>\n";
  }
  else {
    $output['pages'][1]['channel'] = 'SBSNET';
    $output['pages'][1]['num'] = $pagenum1;
    $output['pages'][1]['sub'] = $pagesub1;
    $output['pages'][1]['lang'] = 'S';
    $output['pages'][1]['line1']['number'] = '4';
    $output['pages'][1]['line1']['date'] = $datetext;
    $output['pages'][1]['line1']['color1'] = 'magenta';
    $output['pages'][1]['line1']['color2'] = 'magenta';
    //$tekstpage1 = "<page inserter=\"SBSNET\" num=\"" . $pagenum1 . "\" sub=\"" . $pagesub1 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][2]['channel'] = 'SBSNET';
    $output['pages'][2]['num'] = $pagenum1;
    $output['pages'][2]['sub'] = $pagesub1;
    $output['pages'][2]['lang'] = 'S';
    $output['pages'][2]['line1']['number'] = '4';
    $output['pages'][2]['line1']['date'] = $datetext;
    $output['pages'][2]['line1']['color1'] = 'magenta';
    $output['pages'][2]['line1']['color2'] = 'magenta';
    //$tekstpage2 = "<page inserter=\"SBSNET\" num=\"" . $pagenum2 . "\" sub=\"" . $pagesub2 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][3]['channel'] = 'SBSNET';
    $output['pages'][3]['num'] = $pagenum1;
    $output['pages'][3]['sub'] = $pagesub1;
    $output['pages'][3]['lang'] = 'S';
    $output['pages'][3]['line1']['number'] = '4';
    $output['pages'][3]['line1']['date'] = $datetext;
    $output['pages'][3]['line1']['color1'] = 'magenta';
    $output['pages'][3]['line1']['color2'] = 'magenta';
    //$tekstpage3 = "<page inserter=\"SBSNET\" num=\"" . $pagenum3 . "\" sub=\"" . $pagesub3 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
    $output['pages'][4]['channel'] = 'SBSNET';
    $output['pages'][4]['num'] = $pagenum1;
    $output['pages'][4]['sub'] = $pagesub1;
    $output['pages'][4]['lang'] = 'S';
    $output['pages'][4]['line1']['number'] = '4';
    $output['pages'][4]['line1']['date'] = $datetext;
    $output['pages'][4]['line1']['color1'] = 'magenta';
    $output['pages'][4]['line1']['color2'] = 'magenta';
    //$tekstpage4 = "<page inserter=\"SBSNET\" num=\"" . $pagenum4 . "\" sub=\"" . $pagesub4 . "\" language=\"S\">\n<line num=\"1\"><magenta/><background/><white/>4 <white/><background/><magenta/>" . $datetext . "</line>\n";
  }
  $linenumber1 = 3;
  $linenumber2 = 3;
  $linenumber3 = 3;
  $linenumber4 = 3;

  $data = _ttv_teletext_get_data($date, $channel_tid, '05:56:00');
  foreach ($data as $k => $v) {
    $starttid = substr($v['start_time'], 0, 5);
    $starttid = str_replace(":", "", $starttid);
    $side = "";
    if ($ttvundersider == 1) {
      if (!empty($v['ttv'])) {
        $side = $v['ttv'];
      }
    }
    $newlinenum = 1;

    $linetekst = "";
    $gotext = "";
    if ($v['hd'] == "yes") {
      $hdtekst = "(HD) ";
    }
    else {
      $hdtekst = "";
    }
    if ($v['local'] == 'yes') {
      $localtekst = "/lok. prg. ";
    }
    else {
      $localtekst = "";
    }
    $extratitle = "";
    if ($v['repeat'] == 'yes' || trim($v['repeat']) == "(G)") {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . "(G) " . $localtekst)));
      }
    }
    else {
      if (strlen($v['actors']) >= 1) {
        $programtitle = explode(" ", _ttv_teletext_check_danish($v['title'] . " " . $extratitle . $hdtekst . $localtekst . "NEWLINE " . $v['genre']));
      }
      else {
        $programtitle = explode(" ", _ttv_teletext_check_danish(trim($v['title'] . " " . $extratitle . $hdtekst . $localtekst)));
      }
    }
    foreach ($programtitle as $tekst_num => $tekst) {
      if (strlen($tekst) >= 30) {
        # CUT EFTER 29 TEGN Pï¿½ LINIEN MED - OG Sï¿½T RESTEN Pï¿½ Nï¿½STE LINIE
        if (strlen($linetekst) >= 1) {
          $linetekst .= " ";
        }
        $textlen = (27 - strlen($linetekst));
        $linetekst .= substr($tekst, 0, $textlen) . "-";
        $gotext .= ($linetekst);
        $linetekst = substr($tekst, $textlen, strlen($tekst));
      }
      elseif ($tekst == "NEWLINE") {
        $gotext .= ($linetekst);
        $linetekst = "";
      }
      else {
        # HVIS $tekst + $linetekst >= 29 Sï¿½ SKAL DET Pï¿½ Nï¿½STE LINIE ELLER Pï¿½ NUVï¿½RENDE
        if ((strlen($tekst) + strlen($linetekst)) >= 29) {
          $gotext .= ($linetekst);
          $linetekst = $tekst;
        }
        else {
          if (strlen($linetekst) >= 1) {
            $linetekst .= " ";
          }
          $linetekst .= $tekst;
        }
      }
      if (strlen($gotext) >= 1) {
        if ($newlinenum == 1) {
          $spaces = "";
          for ($i = strlen($gotext); $i <= 28; $i++) {
            $spaces .= " ";
          }
          if ($starttid >= 556 && $starttid <= 1159) {
            $output['pages'][1]['lines'][$linenumber1]['start_time'] = $v['start_time'];
            $output['pages'][1]['lines'][$linenumber1]['title'] = $gotext;
            $output['pages'][1]['lines'][$linenumber1]['description'] = $spaces . $side;
            //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $output['pages'][2]['lines'][$linenumber2]['start_time'] = $v['start_time'];
            $output['pages'][2]['lines'][$linenumber2]['title'] = $gotext;
            $output['pages'][2]['lines'][$linenumber2]['description'] = $spaces . $side;
            //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $output['pages'][3]['lines'][$linenumber3]['start_time'] = $v['start_time'];
            $output['pages'][3]['lines'][$linenumber3]['title'] = $gotext;
            $output['pages'][3]['lines'][$linenumber3]['description'] = $spaces . $side;
            //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
          else {
            $output['pages'][4]['lines'][$linenumber4]['start_time'] = $v['start_time'];
            $output['pages'][4]['lines'][$linenumber4]['title'] = $gotext;
            $output['pages'][4]['lines'][$linenumber4]['description'] = $spaces . $side;
            //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $gotext . "<yellow/>" . $spaces . $side . "</line>\n";
          }
        }
        else {
          if ($starttid >= 556 && $starttid <= 1159) {
            $output['pages'][1]['lines'][$linenumber1]['start_time'] = '';
            $output['pages'][1]['lines'][$linenumber1]['title'] = $gotext;
            $output['pages'][1]['lines'][$linenumber1]['description'] = '';
            //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1200 && $starttid <= 1759) {
            $output['pages'][2]['lines'][$linenumber2]['start_time'] = '';
            $output['pages'][2]['lines'][$linenumber2]['title'] = $gotext;
            $output['pages'][2]['lines'][$linenumber2]['description'] = '';
            //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          elseif ($starttid >= 1800 && $starttid <= 2259) {
            $output['pages'][3]['lines'][$linenumber3]['start_time'] = '';
            $output['pages'][3]['lines'][$linenumber3]['title'] = $gotext;
            $output['pages'][3]['lines'][$linenumber3]['description'] = '';
            //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
          else {
            $output['pages'][4]['lines'][$linenumber4]['start_time'] = '';
            $output['pages'][4]['lines'][$linenumber4]['title'] = $gotext;
            $output['pages'][4]['lines'][$linenumber4]['description'] = '';
            //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $gotext . "</line>\n";
          }
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $linenumber1 += 1;
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $linenumber2 += 1;
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $linenumber3 += 1;
        }
        else {
          $linenumber4 += 1;
          $endtime = $v['end_time'];
        }
        $newlinenum += 1;
        $gotext = "";
      }
    }
    if (strlen($linetekst) >= 1) {
      if ($newlinenum == 1) {
        $spaces = "";
        for ($i = strlen($linetekst); $i <= 28; $i++) {
          $spaces .= " ";
        }
        if ($starttid >= 556 && $starttid <= 1159) {
          $output['pages'][1]['lines'][$linenumber1]['start_time'] = $v['start_time'];
          $output['pages'][1]['lines'][$linenumber1]['title'] = $linetekst;
          $output['pages'][1]['lines'][$linenumber1]['description'] = $spaces . $side;
          //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $output['pages'][2]['lines'][$linenumber2]['start_time'] = $v['start_time'];
          $output['pages'][2]['lines'][$linenumber2]['title'] = $linetekst;
          $output['pages'][2]['lines'][$linenumber2]['description'] = $spaces . $side;
          //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $output['pages'][3]['lines'][$linenumber3]['start_time'] = $v['start_time'];
          $output['pages'][3]['lines'][$linenumber3]['title'] = $linetekst;
          $output['pages'][3]['lines'][$linenumber3]['description'] = $spaces . $side;
          //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
        else {
          $output['pages'][4]['lines'][$linenumber4]['start_time'] = $v['start_time'];
          $output['pages'][4]['lines'][$linenumber4]['title'] = $linetekst;
          $output['pages'][4]['lines'][$linenumber4]['description'] = $spaces . $side;
          //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $v['start_time'] . "<cyan/>" . $linetekst . "<yellow/>" . $spaces . $side . "</line>\n";
        }
      }
      else {
        if ($starttid >= 556 && $starttid <= 1159) {
          $output['pages'][1]['lines'][$linenumber1]['title'] = $linetekst;
          $output['pages'][1]['lines'][$linenumber1]['start_time'] = '';
          $output['pages'][1]['lines'][$linenumber1]['description'] = '';
          //$tekstpage1 .= "<line num=\"" . $linenumber1 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1200 && $starttid <= 1759) {
          $output['pages'][2]['lines'][$linenumber2]['title'] = $linetekst;
          $output['pages'][2]['lines'][$linenumber2]['start_time'] = '';
          $output['pages'][2]['lines'][$linenumber2]['description'] = '';
          //$tekstpage2 .= "<line num=\"" . $linenumber2 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        elseif ($starttid >= 1800 && $starttid <= 2259) {
          $output['pages'][3]['lines'][$linenumber3]['title'] = $linetekst;
          $output['pages'][3]['lines'][$linenumber3]['start_time'] = '';
          $output['pages'][3]['lines'][$linenumber3]['description'] = '';
          //$tekstpage3 .= "<line num=\"" . $linenumber3 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
        else {
          $output['pages'][4]['lines'][$linenumber4]['title'] = $linetekst;
          $output['pages'][4]['lines'][$linenumber4]['start_time'] = '';
          $output['pages'][4]['lines'][$linenumber4]['description'] = '';
          //$tekstpage4 .= "<line num=\"" . $linenumber4 . "\">      <cyan/>" . $linetekst . "</line>\n";
        }
      }
      if ($starttid >= 556 && $starttid <= 1159) {
        $linenumber1 += 1;
      }
      elseif ($starttid >= 1200 && $starttid <= 1759) {
        $linenumber2 += 1;
      }
      elseif ($starttid >= 1800 && $starttid <= 2259) {
        $linenumber3 += 1;
      }
      else {
        $linenumber4 += 1;
        $endtime = $v['end_time'];
      }
      $newlinenum += 1;
      $gotext = "";
    }
  }

  $output['pages'][4]['lines'][$linenumber4]['start_time'] = $endtime;
  $output['pages'][4]['lines'][$linenumber4]['title'] = 'Godnat';
  $output['pages'][4]['lines'][$linenumber4]['description'] = '';
  /* $tekstpage4 .= "<line num=\"" . $linenumber4 . "\"><white/>" . $endtime . "<cyan/>Godnat</line>\n";
    $tekstpage1 .= "</page>\n";
    $tekstpage2 .= "</page>\n";
    $tekstpage3 .= "</page>\n";
    $tekstpage4 .= "</page>\n";

    $output = array();
    $output[1] = $tekstpage1;
    $output[2] = $tekstpage2;
    $output[3] = $tekstpage3;
    $output[4] = $tekstpage4; */
  return $output;
}

/*
 * Notifications managed by Elysia
 */

function ttv_teletext_cronapi($op, $job = NULL) {
  $items['ttv_notification_not_updated_cron'] = array(
    'description' => 'Send e-mail when the files are not updated',
    'rule' => '0 9,14,23 * * *',
    'callback' => 'ttv_notification_not_updated_cron',
  );
  $items['ttv_notification_error_import_cron'] = array(
    'description' => 'Send e-mail when feeds import fail',
    'rule' => '*/1 * * * *',
    'callback' => 'ttv_notification_error_import_cron',
  );
  $items['ttv_teletext_hit_cron'] = array(
    'description' => 'Run update on all teletext pages/channels!',
    'rule' => '*/1 * * * *',
    'callback' => 'ttv_teletext_hit_cron',
  );


  return $items;
}

function ttv_notification_not_updated_cron(){
  $xml_directory_path = 'public://xml_program_files';
  $xml_files = file_scan_directory($xml_directory_path, '/\.xml/');
  $not_updated_files = array();
  $language = language_default();
  $params = array();
  $default_email = variable_get('site_mail', ''); 
  
  if(!empty($xml_files)) {
    foreach($xml_files as $xml_file) {   
     
    if (filemtime($xml_file->uri) != variable_get($xml_file->filename,0)) {
      variable_set($xml_file->filename,filemtime($xml_file->uri));
     } else {
      $not_updated_files[] =  $xml_file->filename.' - '.date('Y-m-d H:i:s', filemtime($xml_file->uri));
     }
    } 
        
    if (!empty($not_updated_files)) {
       $params_files = array(
        'not_updated_files' => implode("<br/>", $not_updated_files),
      );

      drupal_mail('ttv_teletext', 'error_files', variable_get('list_of_receivers', $default_email), $language, $params_files, '', TRUE);
      $not_updated_files = array();
    }
    
  }
  //no files found!
  else {
   drupal_mail('ttv_teletext', 'error_import_no_files', variable_get('list_of_receivers', $default_email), $language, $params, '', TRUE);
  }
}


function ttv_notification_error_import_cron(){
  $default_email = variable_get('site_mail', ''); 
  $query = db_select('watchdog', 'w')->extend('PagerDefault')->extend('TableSort');

  $query->fields('w', array('wid', 'uid', 'severity', 'type', 'timestamp', 'message'));
  $query->condition('w.type', 'feeds')
        ->condition('w.severity', 3);

  $result = $query
    ->limit(1)
    ->orderBy('w.timestamp','DESC')
    ->execute();
  
    $error = $result->fetchAssoc();
    
   
    if (isset($error['timestamp'])){ 

     if (variable_get('error_importing_feeds',time()) < $error['timestamp']) {
      $params_import = array(
        'date' => date('Y-m-d H:i:s', $error['timestamp']),
        'message' => $error['message'],
      );

      drupal_mail('ttv_teletext', 'error_import', variable_get('list_of_receivers', $default_email), $language, $params_import, '', TRUE);
      variable_set('error_importing_feeds',$error['timestamp']);
     } 
    }
}


function ttv_teletext_mail($key, &$message, $params) {
  switch ($key) {
    case 'teletext':
      $message['subject'] = t('Notification from TTV.');
      $message['body'][] = t('Teletext curl request failed!');
      $message['body'][] = t('URI: ').$params['uri'];
      $message['body'][] = t('Data: ').$params['data'];
      break;
    case 'error_files':
      $message['subject'] = t('Notification from TTV.');
      $message['body'][] = t('XML files are not updated!');
      $message['body'][] = t('Not Updated files and date of last update: <br/>').$params['not_updated_files'];
      break;
    case 'error_import':
      $message['subject'] = t('Notification from TTV.');
      $message['body'][] = t('XML import failed!');
      $message['body'][] = t('Date: ').$params['date'];
      $message['body'][] = t('Error message: ').$params['message']; 
      break;
    case 'error_import_no_files' :
      $message['subject'] = t('Notification from TTV.');
      $message['body'][] = t('No files found!');
  }
}

function ttv_teletext_settings() {
  $form = array();
  $form['list_of_receivers'] = array(
    '#type' => 'textfield',
    '#title' => t('List of E-mails to send notifications'),
    '#default_value' => variable_get('list_of_receivers', 'N/A'),
    '#size' => 200,
    '#maxlength' => 200,
    '#description' => t("E-mail(s) to send notifications, if you enter multiple e-mails please use comma separation."),
    '#required' => TRUE,
  );
  return system_settings_form($form);
}

function ttv_teletext_settings_validate($form, &$form_state) {
  $list = check_plain($form_state['values']['list_of_receivers']);
  $email = explode(',', $list);
  if(!is_array($email)) {
    form_set_error('list_of_receivers', 'Please use comma as a separator when entering multiple emails!');
  }
  foreach($email as $e) {
    if(!valid_email_address(trim($e))) {
      form_set_error('list_of_receivers', 'Error! "'.$e.'" is not a valid email!');
    }
  }
}

function ttv_teletext_settings_submit($form, &$form_state) {
  $list_of_receivers = trim($form_state['values']['list_of_receivers']);
  variable_set('list_of_receivers', $list_of_receivers);
}


function ttv_teletext_hit_cron() {
  $channels = array(1, 2, 3);
  $pages = array('100-101', '301-304', '305-329', '335-341', '361-364', '365-368');
  foreach ($channels as $c) {
    foreach ($pages as $p) {
      if (function_exists('ttv_teletext_pages_' . $p)) {
        call_user_func('ttv_teletext_pages_' . $p, $c);
      }
    }
  }
}